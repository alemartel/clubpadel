# Profile Picture Upload Feature Plan

## Overview

Players need to be able to upload a profile picture using Cloudinary as the image hosting service. The profile picture should display in the header's profile option circle and on the profile page. Players should also be able to remove their profile picture.

## Technical Requirements

### Database Schema Changes

**File**: `server/drizzle/0010_add_profile_picture.sql` (new migration file)

- Add `profile_picture_url` column to `app.users` table:
  - Type: `text` (nullable)
  - Stores Cloudinary URL for the uploaded profile picture

**File**: `server/src/schema/users.ts` (modify existing)

- Add `profile_picture_url: text("profile_picture_url")` field to users table schema
- Update `User` type to include the new field

### Cloudinary Integration

**File**: `ui/package.json` (modify existing)

- Add Cloudinary React SDK dependency: `@cloudinary/react` and `cloudinary-core`

**File**: `ui/src/lib/cloudinary.ts` (new file)

- Configure Cloudinary instance with API credentials
- Export upload widget configuration
- Export utility functions for image transformations

**File**: `ui/.env` (environment variables)

- Add `VITE_CLOUDINARY_CLOUD_NAME` environment variable
- Add `VITE_CLOUDINARY_UPLOAD_PRESET` environment variable

### API Implementation

**File**: `server/src/api.ts` (modify existing)

- Add new protected endpoint:
  - `PUT /api/v1/protected/profile/picture` - Update user's profile picture URL
  - `DELETE /api/v1/protected/profile/picture` - Remove user's profile picture

**File**: `ui/src/lib/serverComm.ts` (modify existing)

- Add new API functions:
  - `updateProfilePicture(imageUrl: string)` - Update profile picture URL
  - `removeProfilePicture()` - Remove profile picture
- Update `ProfileUpdateData` interface to include `profile_picture_url`
- Update `getCurrentUser()` response to include `profile_picture_url`

### Profile Page Updates

**File**: `ui/src/pages/Profile.tsx` (modify existing)

- Add profile picture section with:
  - Current profile picture display (using UserAvatar component)
  - Upload button that opens Cloudinary upload widget
  - Remove button (when picture exists)
  - Loading states during upload/removal
- Add form state for `profile_picture_url`
- Handle upload success/error states
- Update form submission to include profile picture URL

**File**: `ui/src/components/ProfilePictureUpload.tsx` (new file)

- Create reusable component for profile picture management
- Props: `currentImageUrl`, `onImageChange`, `onImageRemove`, `loading`
- Features:
  - Image preview with fallback to initials
  - Upload button with Cloudinary widget integration
  - Remove button with confirmation
  - Loading spinner during operations

### Header Avatar Updates

**File**: `ui/src/components/navbar.tsx` (modify existing)

- Update UserAvatar props to use `profile_picture_url` from user data instead of Firebase `photoURL`
- Ensure the avatar displays the uploaded profile picture

**File**: `ui/src/components/user-avatar.tsx` (modify existing)

- Update to prioritize `profile_picture_url` over Firebase `photo_url`
- Maintain fallback to initials when no picture is available

### Data Flow Algorithm

1. **Profile Picture Upload**:
   - User clicks upload button on profile page
   - Cloudinary upload widget opens
   - User selects image file
   - Cloudinary uploads image and returns URL
   - Frontend calls `updateProfilePicture(imageUrl)` API
   - Backend updates `profile_picture_url` in database
   - UI updates to show new profile picture
   - Header avatar automatically updates via user context

2. **Profile Picture Removal**:
   - User clicks remove button on profile page
   - Confirmation dialog appears
   - Frontend calls `removeProfilePicture()` API
   - Backend sets `profile_picture_url` to null
   - UI updates to show initials fallback
   - Header avatar reverts to initials

3. **Profile Picture Display**:
   - UserAvatar component checks for `profile_picture_url` first
   - Falls back to Firebase `photo_url` if no custom picture
   - Falls back to initials if no picture available
   - Consistent display across profile page and header

### Error Handling

- File size validation (max 5MB)
- File type validation (jpg, jpeg, png, webp)
- Network error handling for upload failures
- API error handling for save/remove operations
- User feedback for all operations (success/error messages)
