# Admin Control Panel - Team Change Notifications

## Context

Admins need a dedicated page called "Control panel" accessible from the sidebar to view all team member changes (players joining or leaving teams). The admin should see: player name (the player who was added or removed, not the person who performed the action), action type (joined/removed), team name, and date. Admins can mark notifications as read. By default, the page shows unread notifications ordered by date (newest first). Admins can filter to show read, unread, or all notifications.

## Files/Modules to Update

### Database Schema

**File**: `server/src/schema/teams.ts`
- Add new table `team_change_notifications`:
  - `id` (text, primary key)
  - `user_id` (text, foreign key to users.id, not null) - The player who joined or left (this is the player whose name will be displayed in the notification, not the person who performed the add/remove action)
  - `team_id` (text, foreign key to teams.id, not null) - The team affected
  - `action` (text enum: "joined" | "removed", not null) - The action that occurred
  - `created_at` (timestamp, default now, not null) - When the change occurred
  - `read` (boolean, default false, not null) - Whether admin has marked it as read
  - `read_at` (timestamp, nullable) - When the admin marked it as read

**File**: `server/drizzle/0017_add_team_change_notifications.sql` (new migration file)
- Create `team_change_notifications` table in `app` schema
- Add foreign key constraints:
  - `user_id` references `users.id` (no action on delete/update)
  - `team_id` references `teams.id` (no action on delete/update)
- Add index on `read` column for efficient filtering
- Add index on `created_at` column for efficient date ordering

### Backend API

**File**: `server/src/api.ts`

**Modify `POST /protected/teams/:id/members` endpoint** (around line 1412):
- After successfully adding a team member (after line 1535):
  - Insert a record into `team_change_notifications` table:
    - `user_id`: the `user_id` from the request body (the player who was added to the team, not the team creator/admin who performed the action)
    - `team_id`: the team they joined
    - `action`: "joined"
    - `created_at`: current timestamp
    - `read`: false

**Modify `DELETE /protected/teams/:id/members/:userId` endpoint** (around line 1548):
- After successfully removing a team member (after line 1594):
  - Insert a record into `team_change_notifications` table:
    - `user_id`: the `userId` path parameter (the player who was removed from the team, not the person/admin who performed the removal)
    - `team_id`: the team they left
    - `action`: "removed"
    - `created_at`: current timestamp
    - `read`: false

**Create `GET /admin/team-change-notifications` endpoint** (new admin route):
- Query parameters:
  - `filter` (optional): "read", "unread", or "all" (default: "unread")
- Query `team_change_notifications` table with joins:
  - Join with `users` table on `user_id` to get the player name (the player who was added or removed, not the person who performed the action) - use `display_name` or fallback to `first_name` + `last_name` or `email`
  - Join with `teams` table on `team_id` to get team name
- Filter by `read` status based on `filter` parameter
- Order by `created_at` descending (newest first)
- Return array of notification objects with:
  - `id`: notification id
  - `player_name`: the name of the player who was added or removed (from the `users` table joined on `user_id`)
  - `action`: "joined" or "removed"
  - `team_name`: team name
  - `date`: created_at timestamp
  - `read`: read status
  - `read_at`: read_at timestamp (if read)

**Create `POST /admin/team-change-notifications/:id/read` endpoint** (new admin route):
- Accept notification `id` as path parameter
- Update notification:
  - Set `read` to `true`
  - Set `read_at` to current timestamp
- Return updated notification

### Frontend Types

**File**: `ui/src/lib/serverComm.ts`
- Add `TeamChangeNotification` interface:
  - `id: string`
  - `player_name: string`
  - `action: "joined" | "removed"`
  - `team_name: string`
  - `date: string` (ISO timestamp)
  - `read: boolean`
  - `read_at: string | null` (ISO timestamp)
- Add `getTeamChangeNotifications(filter?: "read" | "unread" | "all")` function that calls `GET /admin/team-change-notifications?filter=<filter>`
- Add `markNotificationAsRead(notificationId: string)` function that calls `POST /admin/team-change-notifications/:id/read`
- Export both functions in the `api` object

### Frontend UI Components

**File**: `ui/src/components/appSidebar.tsx`
- Add new sidebar menu item in the admin section (after line 109, before Settings):
  - Import icon: `PanelLeft` or `LayoutDashboard` from lucide-react (or use existing `Shield`)
  - Add menu item with:
    - `tooltip`: "Control Panel"
    - `isActive`: check for path `/admin/control-panel`
    - `Link`: to `/admin/control-panel`
    - Icon and label for "Control Panel"

**File**: `ui/src/App.tsx`
- Add new route for Control Panel (in admin routes section, around line 199):
  - Path: `/admin/control-panel`
  - Wrap with `AdminRoute` component
  - Render `ControlPanel` component

**File**: `ui/src/pages/ControlPanel.tsx` (new file)
- Create page component with:
  - Header section: "Control Panel" title
  - Filter section:
    - Radio buttons or select dropdown for filter options: "Unread" (default), "Read", "All"
    - Default selection: "Unread"
  - Notifications list:
    - Display notifications in a table or card list format
    - Show columns/fields: Player Name, Action (joined/removed), Team Name, Date
    - Action column: Badge or icon indicating "joined" (green/check) or "removed" (red/cross)
    - Each row/item has a "Mark as read" button (or action icon)
    - Empty state: Show message when no notifications match the filter
  - Loading state: Show loading spinner while fetching
  - Error handling: Display error message if fetch fails
  - Implement filter logic:
    - Default filter: "unread"
    - Refresh list when filter changes
    - Order by date descending (newest first)
  - Implement mark as read:
    - On button click, call API to mark notification as read
    - Update local state optimistically
    - Refresh list if on "unread" filter (notification will disappear)

### Translations

**File**: `ui/src/locales/en/navigation.json`
- Add keys:
  - `"controlPanel": "Control Panel"`

**File**: `ui/src/locales/en/admin.json` (create or update if exists)
- Add keys:
  - `"controlPanel": "Control Panel"`
  - `"teamChangeNotifications": "Team Change Notifications"`
  - `"player": "Player"`
  - `"action": "Action"`
  - `"team": "Team"`
  - `"date": "Date"`
  - `"joined": "Joined"`
  - `"removed": "Removed"`
  - `"markAsRead": "Mark as Read"`
  - `"noNotifications": "No notifications found"`
  - `"filter": "Filter"`
  - `"filterAll": "All"`
  - `"filterRead": "Read"`
  - `"filterUnread": "Unread"`

**File**: `ui/src/locales/es/navigation.json` (create or update if exists)
- Add Spanish translations for navigation keys

**File**: `ui/src/locales/es/admin.json` (create or update if exists)
- Add Spanish translations for all admin keys

## Notification Creation Algorithm

When a team member is added:
1. After successful insert into `team_members` table
2. Insert into `team_change_notifications`:
   - `user_id`: the `user_id` that was added to the team (this is the player whose name will be displayed, not the team creator/admin who added them)
   - `team_id`: the `team_id` where they were added
   - `action`: `"joined"`
   - `created_at`: current timestamp
   - `read`: `false`

When a team member is removed:
1. After successful deletion from `team_members` table
2. Insert into `team_change_notifications`:
   - `user_id`: the `user_id` that was removed from the team (this is the player whose name will be displayed, not the person/admin who removed them)
   - `team_id`: the `team_id` where they were removed
   - `action`: `"removed"`
   - `created_at`: current timestamp
   - `read`: `false`

## Query Algorithm for Notifications

1. Build base query joining:
   - `team_change_notifications` (main table)
   - `users` (for player name via `user_id`)
   - `teams` (for team name via `team_id`)

2. Apply filter:
   - If `filter === "read"`: WHERE `read = true`
   - If `filter === "unread"`: WHERE `read = false`
   - If `filter === "all"` or missing: no read filter

3. Select fields:
   - `team_change_notifications.id`
   - `team_change_notifications.action`
   - `team_change_notifications.created_at as date`
   - `team_change_notifications.read`
   - `team_change_notifications.read_at`
   - Player name: COALESCE(`users.display_name`, CONCAT(`users.first_name`, ' ', `users.last_name`), `users.email`) as `player_name` (this is the name of the player who was added or removed, from the `users` table joined on `user_id`)
   - `teams.name as team_name`

4. Order by `created_at DESC` (newest first)

5. Return array of notification objects

## Mark as Read Algorithm

1. Validate notification exists and belongs to a valid team/user
2. Update `team_change_notifications` table:
   - SET `read = true`
   - SET `read_at = NOW()`
   - WHERE `id = :notificationId`
3. Return updated notification object

