# Team Passcode Join System

## Context

Players need a way to join teams using passcodes. Each team will have a unique random passcode that is generated when the team is created. The passcode is displayed in the team detail information. Players can enter a passcode on the "My Teams" page to join a team. The system will show a confirmation dialog with the team name BEFORE the player joins, so they explicitly know which team they are joining. Existing teams need random passcodes generated for them.

## Files/Modules to Update

### Database Schema

**File**: `server/src/schema/teams.ts`
- Add `passcode` column to the `teams` table schema:
  - Type: `text` 
  - Not null
  - Unique constraint
  - No default (generated at creation time)

**File**: `server/drizzle/0016_add_team_passcode.sql` (new migration file)
- Add `passcode` column to `app.teams` table with unique constraint
- Generate random passcodes for all existing teams using a PostgreSQL function to create unique 6-character alphanumeric codes

### Backend API

**File**: `server/src/api.ts`

**Update `POST /protected/teams` endpoint** (team creation, around line 961):
- Generate a random unique passcode when creating a team
- Algorithm: Generate 6-character alphanumeric passcode (uppercase letters A-Z and digits 0-9)
- Check for uniqueness against existing teams, regenerate if collision occurs
- Store passcode in the database along with other team fields

**Create `GET /protected/teams/lookup?passcode=<passcode>` endpoint** (new endpoint):
- Accept passcode as query parameter
- Validate passcode exists and find team by passcode
- Perform validation checks to determine if user CAN join (but don't join yet):
  - Check if team has fewer than 4 members
  - Validate user is not an admin
  - Validate gender compatibility (masculine/feminine/mixed team rules)
  - Check if user is already on another team with same level AND gender combination
  - Check if user is already a member of this team
- Return team information including team name, level, gender (for confirmation dialog)
- Return validation errors if user cannot join (team full, gender mismatch, etc.)

**Create `POST /protected/teams/join` endpoint** (new endpoint):
- Accept request body with `{ passcode: string }`
- Re-validate passcode exists and find team by passcode
- Re-apply all existing team member validation rules:
  - Check if team has fewer than 4 members
  - Validate user is not an admin
  - Validate gender compatibility (masculine/feminine/mixed team rules)
  - Check if user is already on another team with same level AND gender combination
  - Check if user is already a member of this team
- Add user to team via `team_members` table
- Return team information including team name for success message

**Update `GET /protected/teams/:id` endpoint** (around line 1108):
- Include `passcode` field in the returned team data
- Only return passcode if user is team creator or team member (not for arbitrary users requesting team details)

### Frontend Types

**File**: `ui/src/lib/serverComm.ts`
- Update `Team` interface to include optional `passcode?: string`
- Add `lookupTeamByPasscode(passcode: string)` function that calls `GET /protected/teams/lookup?passcode=<passcode>`
- Add `joinTeam(passcode: string)` function that calls `POST /protected/teams/join`
- Export both new functions in the `api` object

### Frontend UI Components

**File**: `ui/src/pages/MyTeams.tsx`
- Add "Join a Team" button in the header section next to the "Create Team" button (or in the empty state if no teams exist)
- Create a modal/dialog component for joining with passcode:
  - Text input field for passcode entry
  - Submit button to lookup team
  - Loading state during passcode lookup API call
  - Error message display if passcode is invalid or validation fails
  - **Confirmation dialog showing team name BEFORE joining**:
    - Display team name, level, and gender
    - Show "Confirm" and "Cancel" buttons
    - Only proceed with join after user explicitly confirms
  - After confirmation, call join API and show success message

**File**: `ui/src/pages/TeamDetail.tsx`
- Display passcode in the team information section (around line 340-390)
- Show passcode in a readable format (e.g., "Passcode: ABC123")
- Only display passcode if user is team creator or team member (same visibility rule as backend)

### Translations

**File**: `ui/src/locales/en/teams.json`
- Add keys:
  - `"joinTeam": "Join a Team"`
  - `"joinTeamModalTitle": "Join a Team"`
  - `"enterPasscode": "Enter Team Passcode"`
  - `"passcodePlaceholder": "Enter 6-character passcode"`
  - `"lookup": "Lookup Team"`
  - `"lookingUp": "Looking up..."`
  - `"joinConfirmationTitle": "Confirm Join Team"`
  - `"joinConfirmationMessage": "Are you sure you want to join {{teamName}}?"`
  - `"teamDetails": "Team Details"`
  - `"confirmJoin": "Confirm Join"`
  - `"cancel": "Cancel"`
  - `"join": "Join"`
  - `"joining": "Joining..."`
  - `"joinTeamSuccess": "Successfully joined {{teamName}}"`
  - `"invalidPasscode": "Invalid passcode. Please try again."`
  - `"teamPasscode": "Team Passcode"`
  - `"passcode": "Passcode"`

**File**: `ui/src/locales/es/teams.json`
- Add Spanish translations for all the above keys

## Passcode Generation Algorithm

1. **Format**: 6-character alphanumeric string using uppercase letters (A-Z) and digits (0-9)
2. **Generation**:
   - Use random selection from character set `ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789`
   - Generate 6 random characters
   - Check database for uniqueness
   - If collision detected, regenerate (with safety limit to prevent infinite loops)
3. **Uniqueness**: Database unique constraint ensures no duplicates
4. **Implementation**: Use Node.js `crypto.randomBytes()` or equivalent to ensure cryptographically secure randomness, then map to alphanumeric characters

## Data Migration for Existing Teams

**Migration file**: `server/drizzle/0016_add_team_passcode.sql`
- Add `passcode` column as NOT NULL with unique constraint
- Use PostgreSQL function to generate unique passcodes for all existing teams:
  ```sql
  -- Generate passcodes for existing teams
  UPDATE app.teams
  SET passcode = (
    SELECT string_agg(
      substr('ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789', 
        floor(random() * 36)::int + 1, 1), 
      ''
    ) FROM generate_series(1, 6)
  )
  WHERE passcode IS NULL;
  ```
- Ensure uniqueness by using a conflict resolution approach or generating with a loop until unique

## Validation Rules

When a player joins via passcode, apply the same validation rules as when a team creator adds a member:
- Team must have fewer than 4 members
- User cannot be an admin
- User must have gender set in profile
- Gender compatibility: masculine teams only male players, feminine teams only female players
- Mixed teams: when reaching 4 members, must have at least one of each gender
- User cannot already be on another team with same level AND gender combination
- User cannot already be a member of the target team

## Error Handling

- Invalid passcode: Return 404 or 400 with message "Invalid passcode"
- Team full: Return 400 with message "Team is full"
- Gender mismatch: Return 400 with appropriate gender mismatch message
- Already member: Return 409 with message "You are already a member of this team"
- Conflicting team: Return 409 with message about existing team membership
- Admin attempting to join: Return 403 with message "Admins cannot join teams"

