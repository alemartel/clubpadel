# Move Payment Management from Admin Leagues to Admin Players

## Context

Payment management needs to be moved from the admin leagues page to the admin players page. On the admin players page, for each player, we need to display a collapsible list of all leagues and teams (past, active, or future) that the player belongs to. Each item in the list should show "league name + team name" with a payment toggle similar to the one currently in the admin leagues page. Payment is per league and team combination. The admin leagues page should keep payment information display but remove the ability to update payments (read-only).

**Important**: Payment is per league and team combination. A player pays to participate in a specific team within a specific league. When a team moves to a new league, the payment status should be tracked separately for each league.

## Files/Modules to Update

### Backend API Changes

**File**: `server/src/api.ts`

#### Create new endpoint `GET /api/v1/admin/players/:playerId/teams` (new endpoint)

- Fetch all teams that a specific player belongs to, including league information and payment status
- Query should:
  1. Get all `team_members` records where `user_id = playerId`
  2. For each team membership, join with `teams` table
  3. For each team, join with `leagues` table (left join, as team might not be in a league)
  4. Include payment status from `team_members` table (`paid`, `paid_at`, `paid_amount`)
  5. Include league information (even if null)
  6. Order by league status (active first, then by league dates)

**Response structure**:
```typescript
{
  teams: [
    {
      team: {
        id: string;
        name: string;
        level: string;
        gender: string;
        // ... other team fields
      },
      league: {
        id: string;
        name: string;
        start_date: string | null;
        end_date: string | null;
        level: string;
        gender: string;
      } | null,
      payment_status: {
        paid: boolean;
        paid_at: string | null;
        paid_amount: number | null;
      },
      team_member_id: string; // For updating payment
    }
  ]
}
```

**Query logic**:
```sql
SELECT 
  tm.id as team_member_id,
  tm.paid,
  tm.paid_at,
  tm.paid_amount,
  t.*,
  l.*
FROM team_members tm
INNER JOIN teams t ON tm.team_id = t.id
LEFT JOIN leagues l ON t.league_id = l.id
WHERE tm.user_id = :playerId
ORDER BY 
  CASE 
    WHEN l.start_date IS NULL OR l.end_date IS NULL THEN 3
    WHEN l.start_date > NOW() THEN 2
    WHEN l.start_date <= NOW() AND l.end_date >= NOW() THEN 1
    ELSE 3
  END,
  l.start_date DESC NULLS LAST
```

#### Update existing endpoint `POST /api/v1/admin/teams/:teamId/members/:userId/paid` (around line 655)

- This endpoint already exists and updates payment status
- No changes needed - it uses `team_members` table which tracks payment per team membership
- The endpoint is already correct for updating payment per league+team combination (since a team can only be in one league at a time)

### Frontend API Client

**File**: `ui/src/lib/serverComm.ts`

- Add new function `getPlayerTeams(playerId: string)` to fetch teams and leagues for a specific player
- Add interface `PlayerTeamInfo` to type the response:
```typescript
export interface PlayerTeamInfo {
  team: Team;
  league: {
    id: string;
    name: string;
    start_date: string | null;
    end_date: string | null;
    level: string;
    gender: string;
  } | null;
  payment_status: {
    paid: boolean;
    paid_at: string | null;
    paid_amount: number | null;
  };
  team_member_id: string;
}
```
- Export the function in the `api` object

### Frontend Component - Admin Players Page

**File**: `ui/src/pages/AdminPlayers.tsx`

#### Add state for team/league data per player

- Add state: `playerTeamsMap: Record<string, PlayerTeamInfo[]>` to store teams/leagues for each player
- Add state: `expandedPlayers: Set<string>` to track which players have their teams list expanded
- Add state: `teamsLoadingMap: Record<string, boolean>` to track loading state per player
- Add state for payment management (similar to AdminLeagues):
  - `showPaymentDialog: boolean`
  - `paymentTeamMemberId: string | null`
  - `paymentPlayerId: string | null`
  - `paymentAmount: string`
  - `paymentError: string`

#### Add function to load teams for a player

- `loadPlayerTeams(playerId: string)`: Fetches teams and leagues for a specific player using `api.getPlayerTeams(playerId)`
- Store results in `playerTeamsMap`
- Handle loading and error states

#### Add payment toggle functionality

- `handleMarkPaid(playerId: string, teamMemberId: string, currentPaid: boolean, desiredPaid: boolean)`: 
  - If marking as paid, open payment dialog to enter amount
  - If marking as unpaid, directly call API to update
  - After update, refresh the player's teams list
- `handlePaymentDialogConfirm()`: Validates amount and calls API to update payment

#### Update UI to show collapsible teams list

- For each player card, add a collapsible section
- Use `Collapsible`, `CollapsibleTrigger`, `CollapsibleContent` from shadcn/ui
- Collapsible trigger should show "Teams" or "Teams (X)" where X is the number of teams
- Inside collapsible content, display list of team+league items
- Each item should show:
  - League name + team name (e.g., "Liga Verano + Equipo Alpha")
  - Payment status indicator (icon: green checkmark for paid, amber X for unpaid)
  - Payment toggle switch (similar to AdminLeagues)
  - Payment amount (clickable to show details modal) if paid
- Use similar styling to AdminLeagues page for consistency

#### Helper function for league status

- Add `getLeagueStatus(league)` function to determine if league is "not_started", "in_progress", or "completed"
- Use this to optionally group or sort teams by league status

### Frontend Component - Admin Leagues Page

**File**: `ui/src/pages/AdminLeagues.tsx`

#### Remove payment toggle functionality

- Remove `handleMarkPaid` function
- Remove `handlePaymentDialogConfirm` function
- Remove payment dialog state (`showPaymentDialog`, `paymentTeamId`, `paymentUserId`, etc.)
- Remove payment dialog JSX
- Remove payment amount input dialog

#### Keep payment display (read-only)

- Keep payment status indicators (green checkmark, amber X)
- Keep payment amount display (clickable to show details modal)
- Remove the `Switch` component for toggling payment
- Payment information should be display-only

#### Clean up unused imports

- Remove `Switch` import if no longer used
- Keep other imports that are still needed

### Translation Keys

**Files**:
- `ui/src/locales/en/admin.json` and `ui/src/locales/es/admin.json`
- `ui/src/locales/en/common.json` and `ui/src/locales/es/common.json`

**Translation keys to add**:
- `playerTeams`: "Teams" / "Equipos"
- `playerTeamsCount`: "Teams ({{count}})" / "Equipos ({{count}})"
- `noTeamsForPlayer`: "This player is not on any teams" / "Este jugador no está en ningún equipo"
- `leagueTeamDisplay`: "{{leagueName}} + {{teamName}}" / "{{leagueName}} + {{teamName}}"
- `noLeagueForTeam`: "No league" / "Sin liga"

**Translation keys to keep** (already exist):
- Payment-related keys from teams.json and common.json
- `markPaid`, `amountPaid`, `paid`, `notPaid`, etc.

## Algorithmic/Logical Notes

### Payment per League and Team

**Current Schema**: Payment is stored in `team_members` table with `paid`, `paid_at`, `paid_amount` fields. This effectively tracks payment per team membership.

**Important**: Since a team can only be in one league at a time (active or completed), and a player can only be on one team per level/gender combination, the payment status in `team_members` is effectively per league+team combination. When a team moves to a new league, the payment status should be checked in the context of the current league.

**Display Logic**:
- Show all teams a player has been on (via `team_members` records)
- For each team, show the current league it's in (or null if not in a league)
- Payment status is shown per team membership
- When updating payment, we update the `team_members` record

### League Status Calculation

Use the same `getLeagueStatus` helper function:
```typescript
function getLeagueStatus(league: { start_date: string | null; end_date: string | null }): "not_started" | "in_progress" | "completed" {
  const now = new Date();
  if (!league.start_date || !league.end_date) return "not_started";
  const startDate = new Date(league.start_date);
  const endDate = new Date(league.end_date);
  if (startDate > now) return "not_started";
  if (startDate <= now && endDate >= now) return "in_progress";
  return "completed";
}
```

### Sorting Teams

- Sort teams by league status: active first (in_progress, not_started), then completed
- Within each status group, sort by league start_date (most recent first)
- Teams without leagues go last

### Payment Update Flow

1. Admin clicks payment toggle on a team+league item
2. If marking as paid:
   - Open payment dialog
   - Admin enters amount
   - Call `POST /api/v1/admin/teams/:teamId/members/:userId/paid` with `paid: true, paid_amount: amount`
3. If marking as unpaid:
   - Directly call API with `paid: false`
4. Refresh player's teams list to show updated status

## UI/UX Details

### Admin Players Page - Teams List

**Collapsible Section**:
- Each player card should have a collapsible "Teams" section
- Collapsed by default
- Shows count when expanded: "Teams (3)"
- Click to expand/collapse

**Team+League Items**:
- Display format: "{{leagueName}} + {{teamName}}" or "{{teamName}} (No league)" if no league
- Payment status indicator (icon) on the left
- Payment toggle switch on the right
- Payment amount (if paid) below the toggle, clickable to show details
- Similar styling to AdminLeagues page team members list

**Grouping (Optional)**:
- Could group by league status (Active, Past, Future)
- Or just show flat list sorted by status

### Admin Leagues Page - Payment Display

**Read-only Display**:
- Keep payment status indicators (green checkmark, amber X)
- Keep payment amount display with info icon
- Remove toggle switch
- Payment amount is still clickable to show details modal
- Visual indication that payment cannot be changed here

### Consistency

- Use same styling, icons, and components as AdminLeagues page for payment display
- Use same payment dialog for entering amount
- Use same payment details modal for viewing payment information

## Edge Cases

1. **Player with no teams**: Show "This player is not on any teams" message
2. **Team without league**: Display as "{{teamName}} (No league)" or similar
3. **Multiple teams in same league**: Rare but possible if player has been on multiple teams over time (completed leagues don't prevent new team membership)
4. **Payment status update fails**: Show error toast and don't update UI
5. **Team moves to new league**: Payment status remains with team membership, but should be checked in context of new league

## Migration Considerations

- No database migration needed - schema already supports this
- Existing payment data will continue to work
- Payment status is already per team membership, which is correct for league+team combination tracking

