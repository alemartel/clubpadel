# Enhanced Authentication Flow with Separate Login/Register and Password Management

## Context

The current login page automatically registers users if they don't exist, which should be separated into distinct login and register flows. Additionally, users need better error handling for login failures (suggest account creation for non-existent emails, password reset for incorrect passwords) and password change functionality in their profile.

## Files/Modules to Update

### Frontend - Login Component

**File**: `ui/src/components/login-form.tsx`

- Remove automatic registration logic (lines 21-29)
- Update `handleSubmit` function to:
  - Handle `auth/user-not-found` error: Display message suggesting to create account with a button that navigates to `/register` page
  - Handle `auth/wrong-password` or `auth/invalid-credential` error: Display message with button to request password reset via email
  - For password reset: Use `sendPasswordResetEmail` from `firebase/auth` (needs to be imported)
- Add "Register" button alongside "Login" button in the CardFooter
- Add state for password reset flow (email submitted for reset)
- Import `useNavigate` from `react-router-dom` and `sendPasswordResetEmail` from `firebase/auth`
- Import `Link` from `react-router-dom` or use `navigate()` for register button navigation

### Frontend - Register Page Component

**File**: `ui/src/pages/Register.tsx` (new file)

- Create new Register page component similar to LoginForm structure
- Form fields:
  - Email input (required, type="email")
  - Password input (required, type="password", min 6 characters)
  - Confirm password input (required, type="password")
- Form validation:
  - Password must be at least 6 characters
  - Passwords must match
  - Email format validation
- Use `createUserWithEmailAndPassword` from `firebase/auth`
- On successful registration:
  - Show success message
  - Optionally auto-sign in (already happens with `createUserWithEmailAndPassword`) or navigate to home
- On error: Display appropriate error message
- Add "Already have an account?" link/button that navigates back to login
- Use same Card component styling as LoginForm for consistency
- Use translation hook `useTranslation('auth')` for all text

### Frontend - App Routing

**File**: `ui/src/App.tsx`

- Import Register component: `import { Register } from "@/pages/Register"`
- Add new route in the Routes section (around line 149, before closing Routes tag):
  - When user is not authenticated (inside the `!user` condition, around line 124-140): Add conditional rendering to show either LoginForm or Register based on current route
  - Or add routing logic to show Register component at `/register` path
- Update the login page rendering logic to support navigation between login and register views
- Alternatively, wrap both LoginForm and Register in a routing structure that allows switching between them

### Frontend - Profile Page Password Change

**File**: `ui/src/pages/Profile.tsx`

- Add new password change section after the existing profile form (around line 533, before closing CardContent)
- Create new Card or expand existing Card with password change section:
  - CardTitle: "Change Password" (or use translation key)
  - Form fields:
    - Current password input (type="password", required)
    - New password input (type="password", required, min 6 characters)
    - Confirm new password input (type="password", required)
  - Validation:
    - New password must be at least 6 characters
    - New password must match confirm password
    - Current password must be provided
- Add state management:
  - `passwordFormData` state for password fields
  - `passwordLoading` state for async operations
  - `passwordError` and `passwordSuccess` for feedback
- Import Firebase Auth functions:
  - `reauthenticateWithCredential` and `EmailAuthProvider` from `firebase/auth`
  - `updatePassword` from `firebase/auth`
- Handle password change submission:
  1. Re-authenticate user with `reauthenticateWithCredential` using `EmailAuthProvider.credential(email, currentPassword)`
  2. If re-authentication succeeds, call `updatePassword(auth.currentUser, newPassword)`
  3. Show success message on completion
  4. Clear form fields on success
  5. Handle errors appropriately (wrong current password, weak new password, etc.)
- Add translation keys for password change section in profile.json

### Frontend - Translation Files

**File**: `ui/src/locales/en/auth.json`

- Add new translation keys:
  - `"userNotFoundMessage": "No account found with this email. Would you like to create one?"`
  - `"createAccountButton": "Create Account"`
  - `"wrongPasswordMessage": "Incorrect password. Would you like to reset it?"`
  - `"requestPasswordResetButton": "Send Reset Email"`
  - `"passwordResetSent": "Password reset email sent. Please check your inbox."`
  - `"passwordResetError": "Failed to send password reset email"`
  - `"registerButton": "Register"`
  - `"goToLogin": "Back to Login"`

**File**: `ui/src/locales/en/profile.json`

- Add new translation keys:
  - `"changePassword": "Change Password"`
  - `"changePasswordSubtitle": "Update your account password"`
  - `"currentPassword": "Current Password"`
  - `"newPassword": "New Password"`
  - `"confirmNewPassword": "Confirm New Password"`
  - `"currentPasswordPlaceholder": "Enter your current password"`
  - `"newPasswordPlaceholder": "Enter your new password"`
  - `"confirmNewPasswordPlaceholder": "Confirm your new password"`
  - `"passwordChanged": "Password changed successfully"`
  - `"passwordChangeError": "Failed to change password"`
  - `"currentPasswordIncorrect": "Current password is incorrect"`
  - `"passwordsMustMatch": "New passwords must match"`

**File**: `ui/src/locales/es/auth.json`

- Add Spanish translations for all the new keys above

**File**: `ui/src/locales/es/profile.json`

- Add Spanish translations for all the new profile password keys above

## Algorithmic/Logical Notes

### Login Flow with Error Handling

1. User enters email and password, clicks "Login"
2. Call `signInWithEmailAndPassword(auth, email, password)`
3. Handle errors:
   - **Case: `auth/user-not-found`**:
     - Display message: "No account found with this email. Would you like to create one?"
     - Show "Create Account" button that navigates to `/register` page
   - **Case: `auth/wrong-password` or `auth/invalid-credential`**:
     - Display message: "Incorrect password. Would you like to reset it?"
     - Show "Send Reset Email" button
     - On button click: Call `sendPasswordResetEmail(auth, email)`
     - Show success message: "Password reset email sent. Please check your inbox."
   - **Case: Other errors**: Display generic error message
4. On successful login: User is automatically redirected (handled by existing auth flow)

### Register Flow

1. User navigates to `/register` page (via register button or direct URL)
2. User fills form: email, password, confirm password
3. Validate:
   - Email format
   - Password length (min 6 characters)
   - Password and confirm password match
4. On submit: Call `createUserWithEmailAndPassword(auth, email, password)`
5. On success: User is automatically signed in and redirected to home page
6. On error: Display error message (e.g., email already exists, weak password)

### Password Change Flow

1. User navigates to Profile page
2. Scrolls to "Change Password" section
3. Enters current password, new password, confirm new password
4. Validate:
   - Current password provided
   - New password length (min 6 characters)
   - New password matches confirm password
5. On submit:
   - Re-authenticate: `reauthenticateWithCredential(auth.currentUser, EmailAuthProvider.credential(email, currentPassword))`
   - If re-authentication succeeds: `updatePassword(auth.currentUser, newPassword)`
   - Show success message and clear form
6. Error handling:
   - Wrong current password: Show "Current password is incorrect"
   - Weak new password: Show Firebase error message
   - Network errors: Show generic error message

### Password Reset Email Flow

1. User clicks "Send Reset Email" button on login page (after wrong password error)
2. Call `sendPasswordResetEmail(auth, email)` with the email from the login form
3. Firebase sends password reset email to user
4. User clicks link in email (handled by Firebase, redirects to configured URL)
5. User sets new password through Firebase's password reset flow
6. User can then login with new password

## UI/UX Details

### Login Page Updates
- Replace single "Login / Sign Up" button with two separate buttons: "Login" and "Register"
- Error messages should be contextual and actionable
- Password reset button should appear inline with error message
- Use consistent Card component styling

### Register Page
- Match LoginForm styling exactly (same Card, same layout)
- Include "Already have an account?" link at bottom that navigates back to login
- Show password requirements (min 6 characters) as helper text
- Clear error messages for validation failures

### Profile Password Change
- Add as a new Card section or expand existing Card
- Visually separate from personal information section
- Show success/error messages inline
- Clear form on successful password change
- Consider adding visual indicator for password strength (optional enhancement)

