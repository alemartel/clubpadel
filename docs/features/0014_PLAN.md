# Update Team Creation with Direct Level/Gender Selection - Technical Plan

## Overview

Update the team creation functionality to allow players to create teams by directly specifying a name, level (1, 2, 3, 4), and gender (masculine, feminine, mixed), instead of selecting from existing leagues and groups. After team creation, players are redirected to the team detail page where they can add more players using a player searcher that filters by gender compatibility and excludes admins. Implement validation rules for gender compatibility and enforce a maximum of 4 players per team. Add a gender field to the users table to support gender-based team member filtering.

## Technical Requirements

### Database Schema Changes

#### Add Gender Field to Users Table

**File**: `server/src/schema/users.ts`

- Add `gender` field to `users` table:
  - Type: `genderEnum` (references existing `genderEnum` from `server/src/schema/enums.ts`)
  - Nullable: `true` (to support existing users without gender)
  - Values: `"male"`, `"female"`, `"mixed"` (note: user requirement specifies "masculine", "femenine", and "mixed" but enum uses "male"/"female", need to map appropriately in UI/validation)

#### Add Level and Gender Fields to Teams Table

**File**: `server/src/schema/teams.ts`

- Add `level` field to `teams` table:
  - Type: `levelEnum` (import from `server/src/schema/leagues.ts`)
  - Nullable: `false` (required)
  - Default: none

- Add `gender` field to `teams` table:
  - Type: `genderEnum` (import from `server/src/schema/leagues.ts`)
  - Nullable: `false` (required)
  - Default: none

- Make `league_id` and `group_id` nullable:
  - Change `league_id` and `group_id` from `notNull()` to nullable
  - This allows teams to exist independently of leagues/groups

**Database Migration**

**File**: `server/drizzle/0014_add_gender_to_users_and_level_gender_to_teams.sql` (new migration file)

- Add `gender` column to `app.users` table (nullable, using existing `gender` enum)
- Add `level` column to `app.teams` table (using existing `level` enum, not null)
- Add `gender` column to `app.teams` table (using existing `gender` enum, not null)
- Alter `app.teams` to make `league_id` and `group_id` nullable (using `ALTER COLUMN`)

### API Implementation

#### Update Team Creation Endpoint

**File**: `server/src/api.ts`

- Modify `POST /protected/teams` endpoint:
  - Change request body validation from `{ name, league_id, group_id }` to `{ name, level, gender }`
  - Remove league and group existence validation
  - Validate level is one of: "1", "2", "3", "4"
  - Validate gender is one of: "male", "female", "mixed" (map from "masculine"/"femenine" if needed)
  - Validate team creator's gender matches team gender requirement (masculine teams require male creator, feminine teams require female creator, mixed teams can have any creator)
  - Create team without `league_id` and `group_id` (set to null)
  - Update team name uniqueness check: Since teams no longer belong to leagues, check uniqueness globally or within level/gender combination
  - Add creator as first team member with role "captain"

#### Update Add Team Member Endpoint

**File**: `server/src/api.ts`

- Modify `POST /teams/:id/members` endpoint:
  - Get team's gender and level from team record
  - Before adding member, validate:
    1. Team has fewer than 4 members (count existing members in `team_members` table)
    2. Gender compatibility:
       - Masculine teams (`gender = "male"`): Only allow players with `gender = "male"`
       - Feminine teams (`gender = "female"`): Only allow players with `gender = "female"`
       - Mixed teams (`gender = "mixed"`): Allow both male and female players, but must contain at least one of each gender when fully populated (enforce on add: if adding would make team have 4 members, verify it has both genders)
    3. Player is not an admin (`role != "admin"`)
    4. Player is not already on another team (keep existing league-level check or make it global)
  - Return appropriate error messages for each validation failure

#### Update Free Player Market Endpoint

**File**: `server/src/api.ts`

- Modify `GET /protected/players/free-market` endpoint:
  - Add filtering by player gender:
    - If `gender` query parameter is "male", only return users with `gender = "male"` and `role = "player"`
    - If `gender` query parameter is "female", only return users with `gender = "female"` and `role = "player"`
    - If `gender` query parameter is "mixed", return users with either `gender = "male"` or `gender = "female"` and `role = "player"`
  - Exclude admins: Add filter `eq(users.role, "player")` to only return players
  - Keep existing logic to exclude users already on teams (may need to update if teams no longer require league_id)
  - Continue to accept `league_id` parameter but make it optional (for backwards compatibility or future league features)

#### Update Profile Update Endpoint

**File**: `server/src/api.ts`

- Modify `PUT /protected/profile` endpoint:
  - Accept `gender` field in request body
  - Validate `gender` is one of: "male", "female", "mixed" (or null)
  - Update user's `gender` field in database

#### Update Get Current User Endpoint

**File**: `server/src/api.ts`

- Modify `GET /protected/me` endpoint:
  - Include `gender` field in returned user object

### Frontend Implementation

#### Update Create Team Page

**File**: `ui/src/pages/CreateTeam.tsx`

- Remove league and group selection UI:
  - Remove `selectedLeagueId` and `selectedGroupId` state
  - Remove league and group data loading (`loadLeagues`, `loadGroups`)
  - Remove `leagues` and `groups` state
  - Remove league and group dropdown Select components

- Add new form fields:
  - Team name input (keep existing)
  - Level dropdown (Select component):
    - Options: "1", "2", "3", "4"
    - Required field
    - Store in `selectedLevel` state
  - Gender dropdown (Select component):
    - Options: "Masculine", "Femenine", "Mixed" (for display)
    - Map to backend values: "male", "female", "mixed"
    - Required field
    - Store in `selectedGender` state

- Update form submission:
  - Change `handleSubmit` to send `{ name, level, gender }` instead of `{ name, league_id, group_id }`
  - Map display gender values to backend values before submission
  - Validate creator's gender matches team gender (if creator has gender set):
    - If team is masculine, creator must be male (or show warning/error)
    - If team is feminine, creator must be female (or show warning/error)
    - Mixed teams allow any creator

- Update navigation after creation:
  - Keep redirect to `/teams/${response.team.id}` (team detail page)

#### Update Team Detail Page

**File**: `ui/src/pages/TeamDetail.tsx`

- Update team display:
  - Show team's level and gender from team object (instead of from group)
  - Remove league/group information display (or make optional)
  - Display team member count with maximum (e.g., "2/4 players")

- Update FreePlayerMarketModal integration:
  - Pass team's `level` and `gender` to modal (instead of from group)
  - Ensure modal receives correct team ID and level/gender

- Add validation feedback:
  - Disable "Add Players" button when team has 4 members
  - Show message when team is full
  - Show gender compatibility warnings if applicable

#### Update Free Player Market Components

**File**: `ui/src/components/FreePlayerMarketModal.tsx`
**File**: `ui/src/components/FreePlayerMarket.tsx`

- Update player loading:
  - Pass team's `gender` to `api.getFreePlayers()` (already supports this, but ensure correct value mapping)
  - Ensure `level` parameter is passed correctly
  - Remove or make `leagueId` optional (or pass null/empty if teams don't require leagues)

- Update player display:
  - Show player gender badge/indicator if applicable
  - Filter out admins (should be handled by backend, but add client-side safety check)

#### Update Profile Page

**File**: `ui/src/pages/Profile.tsx`

- Add gender field to profile form:
  - Add gender Select dropdown:
    - Options: "Masculine", "Femenine", "Mixed" (display)
    - Map to backend: "male", "female", "mixed"
    - Add to `formData` state
    - Add to form submission (`handleSubmit`)
    - Load current gender value in `fetchUserData`

#### Update API Client

**File**: `ui/src/lib/serverComm.ts`

- Update `createTeam` function:
  - Change `NewTeam` type to accept `{ name: string, level: string, gender: string }` instead of `{ name: string, league_id: string, group_id: string }`
  - Update request body to send new fields

- Update `ProfileUpdateData` interface:
  - Add `gender?: string` field

- Update `getFreePlayers` function:
  - Ensure `gender` parameter mapping is correct
  - Make `leagueId` parameter optional (or allow null/empty string)

- Update `ServerUser` type in `auth-context.tsx`:
  - Add `gender?: string` field to exported `ServerUser` type

#### Update Types

**File**: `ui/src/lib/serverComm.ts`

- Update `Team` interface:
  - Add `level: string`
  - Add `gender: string`
  - Make `league_id?: string | null`
  - Make `group_id?: string | null`

- Update `NewTeam` type:
  - Change to `{ name: string, level: string, gender: string }`

### Validation Rules Implementation

#### Backend Validation (API)

**File**: `server/src/api.ts`

- Team creation validation:
  - Level must be "1", "2", "3", or "4"
  - Gender must be "male", "female", or "mixed"
  - Team creator's gender (if set) must be compatible with team gender:
    - Masculine team requires male creator
    - Feminine team requires female creator
    - Mixed team allows any creator

- Team member addition validation:
  - Team must have fewer than 4 members
  - Player's gender must match team's gender requirement:
    - Masculine teams only accept male players
    - Feminine teams only accept female players
    - Mixed teams accept both genders, but must have at least one of each when reaching 4 members
  - Player must have role "player" (not "admin")
  - Player must not already be on another team

#### Frontend Validation (UI)

**File**: `ui/src/pages/CreateTeam.tsx`

- Form validation:
  - Team name required and non-empty
  - Level selection required
  - Gender selection required
  - Show warning if creator's gender doesn't match selected team gender (for masculine/feminine teams)

**File**: `ui/src/pages/TeamDetail.tsx`

- UI feedback:
  - Disable "Add Players" button when team has 4 members
  - Show "Team is full (4/4 players)" message
  - Show gender mismatch warnings when applicable

### Translation Keys

**Files**: 
- `ui/src/locales/en/teams.json`
- `ui/src/locales/es/teams.json`

- Add new keys:
  - `"selectLevel"`: "Select Level"
  - `"selectGender"`: "Select Gender"
  - `"level"`: "Level"
  - `"gender"`: "Gender"
  - `"masculine"`: "Masculine"
  - `"femenine"`: "Femenine" (or "Feminine" for English)
  - `"mixed"`: "Mixed"
  - `"teamFull"`: "Team is full ({{count}}/4 players)"
  - `"maxPlayersReached"`: "Maximum number of players (4) reached"
  - `"genderMismatch"`: "Your gender does not match this team's gender requirement"
  - `"addPlayersDisabled"`: "Cannot add more players. Team is full."

**Files**:
- `ui/src/locales/en/profile.json`
- `ui/src/locales/es/profile.json`

- Add new keys:
  - `"gender"`: "Gender"
  - `"selectGender"`: "Select your gender"

### Algorithm: Mixed Team Gender Validation

When adding a player to a mixed team:

1. Get current team members and their genders
2. Count male members: `maleCount`
3. Count female members: `femaleCount`
4. Get new player's gender
5. If adding new player would make team have 4 members:
   - If new player is male: Verify `(maleCount + 1) >= 1 AND (femaleCount) >= 1`
   - If new player is female: Verify `(maleCount) >= 1 AND (femaleCount + 1) >= 1`
6. If validation fails, return error: "Mixed teams must contain both masculine and feminine players"

### Notes

- The enum values use "male"/"female" but the user requirement specifies "masculine"/"femenine". The UI should display "Masculine"/"Femenine" but map to "male"/"female" for backend communication.
- Teams can now exist without leagues/groups, but the database schema retains `league_id` and `group_id` as nullable fields for potential future use.
- The free player market endpoint still accepts `league_id` for backwards compatibility, but it's optional. When teams don't have leagues, pass `null` or omit the parameter.
- Maximum player count validation happens both on frontend (UI feedback) and backend (enforcement).
- Gender validation for mixed teams ensures both genders are represented when the team reaches 4 members, but allows teams with fewer than 4 members to have any gender composition initially.

