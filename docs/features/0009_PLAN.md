# League Calendar Generation Feature

## Description
Implement a league calendar generation system that allows admins to create match schedules for groups based on team availability. The system will generate a round-robin tournament where each team plays every other team exactly once, with matches scheduled weekly based on team availability preferences.

## Database Schema Changes

### New Table: `matches`
**File**: `server/src/schema/leagues.ts`
- `id`: text (primary key)
- `league_id`: text (foreign key to leagues.id)
- `group_id`: text (foreign key to groups.id) 
- `home_team_id`: text (foreign key to teams.id)
- `away_team_id`: text (foreign key to teams.id)
- `match_date`: timestamp (date of the match)
- `match_time`: time (time of the match)
- `week_number`: integer (1, 2, 3, etc.)
- `created_at`: timestamp
- `updated_at`: timestamp

### Schema Modifications
**File**: `server/src/schema/leagues.ts`
- Modify `leagues` table to make `start_date` and `end_date` nullable
- Add migration to set existing league dates to NULL

## Database Migration
**File**: `server/drizzle/0009_add_matches_and_nullable_dates.sql`
- Create `matches` table
- Alter `leagues` table to make `start_date` and `end_date` nullable
- Update existing leagues to set dates to NULL

## API Endpoints

### Calendar Generation
**File**: `server/src/api.ts`
- `POST /api/v1/admin/groups/:groupId/generate-calendar`
  - Body: `{ start_date: string }`
  - Generates matches for all teams in the group
  - Updates league start_date and end_date
  - Returns generated matches

### Calendar Retrieval
**File**: `server/src/api.ts`
- `GET /api/v1/admin/groups/:groupId/calendar`
  - Returns all matches for the group
  - Includes team names and match details

### League Date Updates
**File**: `server/src/api.ts`
- `PUT /api/v1/admin/leagues/:id/dates`
  - Updates league start_date and end_date
  - Used internally by calendar generation

## Calendar Generation Algorithm

### Round-Robin Tournament Algorithm
**File**: `server/src/lib/calendar-generator.ts` (new file)

1. **Input Validation**:
   - Verify group has at least 2 teams
   - Validate start_date is in the future
   - Check all teams have availability data

2. **Team Pairing Generation**:
   - Generate all possible team pairs (n choose 2)
   - For 5 teams: (A,B), (A,C), (A,D), (A,E), (B,C), (B,D), (B,E), (C,D), (C,E), (D,E)

3. **Weekly Scheduling**:
   - Calculate total weeks needed: `Math.ceil(total_matches / max_matches_per_week)`
   - For 5 teams: 10 matches, max 2-3 per week = 4-5 weeks
   - Distribute matches evenly across weeks

4. **Availability Matching**:
   - For each week, find common available days/times
   - Prioritize days with most team availability
   - Assign specific times based on team preferences

5. **Home/Away Assignment**:
   - Alternate home/away for each team pair
   - Ensure balanced home/away distribution

## Frontend Components

### Generate Calendar Modal
**File**: `ui/src/components/GenerateCalendarModal.tsx` (new file)
- Date picker for start date
- Validation for future dates
- Loading state during generation
- Success/error feedback

### Calendar Display Component
**File**: `ui/src/components/GroupCalendar.tsx` (new file)
- Weekly view of matches
- Team names and match times
- Match status indicators
- Responsive grid layout

### Group Detail Page Updates
**File**: `ui/src/pages/AdminTeams.tsx`
- Add "Generate Calendar" button (admin only)
- Add calendar section below teams list
- Show calendar generation status
- Display generated matches

## API Integration

### Server Communication
**File**: `ui/src/lib/serverComm.ts`
- `generateGroupCalendar(groupId: string, startDate: string)`
- `getGroupCalendar(groupId: string)`
- `updateLeagueDates(leagueId: string, startDate: string, endDate: string)`

### Type Definitions
**File**: `ui/src/lib/serverComm.ts`
```typescript
interface Match {
  id: string;
  league_id: string;
  group_id: string;
  home_team_id: string;
  away_team_id: string;
  match_date: string;
  match_time: string;
  week_number: number;
  home_team: { name: string };
  away_team: { name: string };
}
```

## Implementation Phases

### Phase 1: Database Layer
1. Create matches table schema
2. Modify leagues table for nullable dates
3. Create and run database migration
4. Update TypeScript types

### Phase 2A: Backend API
1. Implement calendar generation algorithm
2. Create API endpoints for calendar operations
3. Add league date update functionality
4. Implement match scheduling logic

### Phase 2B: Frontend UI
1. Create GenerateCalendarModal component
2. Create GroupCalendar display component
3. Update AdminTeams page with calendar section
4. Add API integration functions

### Phase 3: Integration & Testing
1. Connect frontend to backend APIs
2. Test calendar generation with various team counts
3. Validate availability matching logic
4. Test responsive calendar display

## Key Technical Considerations

1. **Availability Conflict Resolution**: When multiple teams have conflicting availability, prioritize days with most team coverage
2. **Time Slot Assignment**: Use team availability start/end times to assign specific match times
3. **Week Distribution**: Ensure matches are evenly distributed across weeks to avoid clustering
4. **Data Validation**: Verify all teams have complete availability data before generation
5. **Error Handling**: Graceful handling of insufficient teams or missing availability data
6. **Performance**: Efficient algorithm for large groups (10+ teams)
