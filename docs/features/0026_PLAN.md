# Payment Warning on Home Page

## Context

When a player belongs to a team and that team belongs to an active league (not started or in progress), and the player hasn't paid yet for that league, the player should see a warning on the home page to remind them to pay.

**Important**: Payment is per league, not per player. A player pays to participate in a league. When that league finishes and the player joins a new league (via their team), they need to pay again for the new league. Each league participation requires a separate payment.

## Files/Modules to Update

### Backend API Changes

**File**: `server/src/api.ts`

#### Update `/api/v1/protected/teams` endpoint (around line 1120-1167)

- Modify the endpoint to include payment status for the current user in each team
- Add a query to fetch `team_members` data for the current user, including `paid`, `paid_at`, and `paid_amount` fields
- Include payment status in the response for each team

**Response structure change**:
```typescript
{
  teams: [
    {
      team: Team,
      league: League | null,
      member_count: number,
      user_payment_status: {
        paid: boolean,
        paid_at: string | null,
        paid_amount: number | null
      } | null
    }
  ]
}
```

**Query logic**:
1. For each team the user belongs to, fetch their `team_members` record
2. Extract `paid`, `paid_at`, and `paid_amount` from the `team_members` table where `team_id` matches and `user_id` matches the current user
3. Include this data in the response

### Frontend API Client

**File**: `ui/src/lib/serverComm.ts`

- Update the `TeamWithDetails` interface (or create a new interface) to include `user_payment_status`
- The `getMyTeams()` function already returns the response, so no changes needed to the function itself, but TypeScript types should be updated

**Interface update**:
```typescript
interface TeamWithDetails {
  team: Team;
  league: {
    id: string;
    name: string;
    start_date: string;
    end_date: string;
  } | null;
  member_count: number;
  user_payment_status?: {
    paid: boolean;
    paid_at: string | null;
    paid_amount: number | null;
  } | null;
}
```

### Frontend Component

**File**: `ui/src/components/PaymentWarning.tsx` (new file)

- Create a new component similar to `ProfileWarning.tsx`
- Component should:
  - Accept `teams` prop (array of `TeamWithDetails`)
  - Check if user has any teams in active leagues where they haven't paid
  - Display a warning Alert if payment is needed
  - Include a button/link to navigate to the teams page or a payment page

**Component logic**:
1. Filter teams to find those where:
   - `league` is not null (team belongs to a league)
   - League is active (using `getLeagueStatus` logic: `start_date <= now && end_date >= now`, or `start_date > now` for not started)
   - `user_payment_status.paid === false` (or `paid` is null/undefined)
2. If any such teams exist, render the warning
3. Show league name and team name in the warning message
4. Include a button to navigate to `/teams` page

**UI Structure**:
- Use `Alert` component from `@/components/ui/alert`
- Similar styling to `ProfileWarning` (yellow/amber theme)
- Include `AlertCircle` icon from `lucide-react`
- Button to navigate to teams page

### Home Page Update

**File**: `ui/src/pages/Home.tsx`

- Import `PaymentWarning` component
- Import `useState` and `useEffect` hooks
- Add state to store user's teams
- Fetch teams on component mount using `api.getMyTeams()`
- Pass teams to `PaymentWarning` component
- Render `PaymentWarning` below `ProfileWarning` (or above, depending on priority)

**Implementation steps**:
1. Add state: `const [userTeams, setUserTeams] = useState<TeamWithDetails[]>([]);`
2. Add `useEffect` to fetch teams on mount
3. Render `<PaymentWarning teams={userTeams} />` in the component

### Translation Keys

**Files**:
- `ui/src/locales/en/common.json` (or create `ui/src/locales/en/home.json`)
- `ui/src/locales/es/common.json` (or create `ui/src/locales/es/home.json`)

**Translation keys to add**:
- `paymentWarningTitle`: "Payment Required" / "Pago Requerido"
- `paymentWarningMessage`: "You have unpaid fees for active leagues" / "Tienes pagos pendientes para ligas activas"
- `paymentWarningDetails`: "{{teamName}} in {{leagueName}}" / "{{teamName}} en {{leagueName}}"
- `paymentWarningAction`: "View Teams" / "Ver Equipos"
- `paymentWarningMultipleTeams`: "You have unpaid fees for {{count}} active league(s)" / "Tienes pagos pendientes para {{count}} liga(s) activa(s)"

## Algorithmic/Logical Notes

### League Status Calculation (Frontend)

The frontend needs to determine if a league is "active" (not_started or in_progress):

```typescript
function getLeagueStatus(league: { start_date: string | null; end_date: string | null }): "not_started" | "in_progress" | "completed" {
  const now = new Date();
  
  if (!league.start_date || !league.end_date) {
    return "not_started";
  }
  
  const startDate = new Date(league.start_date);
  const endDate = new Date(league.end_date);
  
  if (startDate > now) {
    return "not_started";
  }
  if (startDate <= now && endDate >= now) {
    return "in_progress";
  }
  return "completed";
}
```

**Active league check**: A league is "active" if status is `"not_started"` or `"in_progress"`.

### Payment Status Check

For each team:
1. Check if `team.league` is not null (team belongs to a league)
2. If league exists, calculate league status using `getLeagueStatus`
3. If status is "not_started" or "in_progress", check `user_payment_status`
4. If `user_payment_status.paid === false` (or is null/undefined), this league requires payment

**Note**: Payment is per league. When a league finishes and the player's team joins a new league, the payment status should be checked for the new league. The `team_members.paid` field represents payment for the current league that the team is participating in. If a team moves to a new league, the payment status may need to be reset or checked in the context of the new league.

### Warning Display Logic

- Show warning if at least one team matches: `(league exists) && (league is active) && (paid === false)`
- If multiple teams match, show a summary message with count
- Optionally list all unpaid teams/leagues in the warning description
- Include a single action button to navigate to teams page

### Edge Cases

1. **No teams**: Don't show warning
2. **Teams without leagues**: Don't show warning (payment only required for league participation)
3. **Completed leagues**: Don't show warning (past leagues don't require payment - player already paid for that league or league is finished)
4. **Already paid for current league**: Don't show warning
5. **Multiple unpaid leagues**: Show aggregated warning with count or list (player may be in multiple teams in different active leagues, each requiring separate payment)
6. **Admin users**: Should not see this warning (admins don't pay)
7. **Team moves to new league**: When a team finishes one league and joins a new active league, the player needs to pay for the new league (even if they paid for the previous league)

## UI/UX Details

### Warning Appearance

- Similar to `ProfileWarning` component:
  - Yellow/amber Alert with border
  - AlertCircle icon
  - Clear title and description
  - Action button to view teams

### Warning Message Examples

**Single league**:
"Payment Required: You have unpaid fees for {{teamName}} in {{leagueName}}"

**Multiple leagues**:
"Payment Required: You have unpaid fees for 2 active leagues"

**Note**: The warning should clearly indicate that payment is required for the specific league(s) the player's team(s) are participating in. Each league requires a separate payment.

### Button Action

- Navigate to `/teams` page where user can see their teams and payment status
- Or navigate to a specific team detail page if only one team needs payment

### Visibility

- Warning should appear below (or above) the profile warning on the home page
- Only visible to non-admin users
- Should update when teams/payment status changes (refresh on page load)

