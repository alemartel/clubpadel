# Eventos (Americanos) – Admin Page

## Description

New admin page **"Eventos"** to create and manage **Americanos**. Base concept: **EVENTO** (event). One event type is `tipo_evento = "americano"`.

Americano here is **not** the classic rotating-pairs format. It is **Americano por equipos (round robin)**:
- Fixed teams (pairs)
- All teams play each other exactly once
- Single-day event
- Classification by teams

No times or courts. Classification is **not** persisted; it is always computed from match results. On result edit, stats and classification update in real time.

---

## Data Layer

### New Schema

**File**: `server/src/schema/events.ts` (new)

- **Enum**: `eventTypeEnum("tipo_evento", ["americano"])` — extensible for future event types.
- **Table `events`**: `id` (PK), `name` (text), `tipo_evento` (enum, default `"americano"`), `created_by` (FK users.id), `created_at`, `updated_at`.
- **Table `event_teams`**: `id` (PK), `event_id` (FK events.id), `name` (text, e.g. "Pareja 1"), `created_at`, `updated_at`. Unique on `(event_id, name)`.
- **Table `event_team_members`**: `id` (PK), `event_team_id` (FK event_teams.id), `user_id` (FK users.id). Unique on `(event_team_id, user_id)`. For Americano, exactly 2 members per event_team (enforced in API, not DB).
- **Table `event_matches`**: `id` (PK), `event_id` (FK events.id), `round_number` (integer, 1..N-1), `home_team_id` (FK event_teams.id), `away_team_id` (FK event_teams.id), `resultado_local` (integer, nullable), `resultado_visitante` (integer, nullable), `created_at`, `updated_at`. Unique on `(event_id, home_team_id, away_team_id)` to enforce all pairings unique.

No classification table. Classification is computed on demand from `event_matches`.

**File**: `server/src/schema/enums.ts`
- Add export/use of `eventTypeEnum` if defined here, or define in `events.ts` and re-export from schema index if present.

**File**: `server/src/schema/users.ts` (or shared schema)
- No change; `events` reference `users.id` for `created_by`.

**Migrations**: Add Drizzle migration for new tables and enum (run after schema changes).

---

## Backend API

**File**: `server/src/api.ts`

- **Mount**: New router `eventRoutes` under admin, e.g. `adminRoutes.route("/events", eventRoutes)` or mount under `api.route("/admin", adminRoutes)` with paths like `/admin/events`.
- **Auth**: All event routes require admin (already under `adminRoutes`).

**Endpoints**:

1. **GET /api/v1/admin/events** — List events (admin). Return `id`, `name`, `tipo_evento`, `created_at`, optionally team count and match count.
2. **POST /api/v1/admin/events** — Create event. Body: `{ name: string }`. Creates event with `tipo_evento: "americano"`. Returns created event.
3. **GET /api/v1/admin/events/:eventId** — Get one event with its teams (and each team’s members with user info) and matches. Used for event detail and classification view.
4. **PUT /api/v1/admin/events/:eventId** — Update event (e.g. name). No change to tipo_evento for now.
5. **DELETE /api/v1/admin/events/:eventId** — Delete event (cascade deletes event_teams, event_team_members, event_matches).

6. **POST /api/v1/admin/events/:eventId/teams** — Add team to event. Body: `{ name: string, user_ids: [string, string] }`. Validate exactly 2 user_ids; both must exist and be players; optional: same user not in two teams of same event. Insert `event_teams` + `event_team_members`.
7. **DELETE /api/v1/admin/events/:eventId/teams/:teamId** — Remove team from event (only if event has no generated matches, or define policy: e.g. allow only before "generating" matches).

8. **POST /api/v1/admin/events/:eventId/generate-matches** — Generate round-robin matches. Validate team count is one of 6, 8, 10, 12, 14. If valid, generate N-1 rounds, N/2 matches per round, all pairings unique; insert `event_matches` with `resultado_local`/`resultado_visitante` null. Idempotency: either replace all matches for event or return error if matches already exist (recommended: "matches already generated" to avoid accidental overwrite).
9. **GET /api/v1/admin/events/:eventId/matches** — List matches for event (by round, then by pair). Used for calendar view and result input.
10. **PUT /api/v1/admin/events/:eventId/matches/:matchId** — Update match result. Body: `{ resultado_local?: number | null, resultado_visitante?: number | null }`. Validate non-negative integers. Persist; classification is not stored, only recomputed when requested.
11. **GET /api/v1/admin/events/:eventId/classifications** — Compute and return classification. **Not persisted.** Algorithm below. Response: array of team rows with PJ, PG, PP, PF, PC, DIF, PTS, ordered by PTS desc then name asc.

**Reuse**: Round-robin algorithm similar to `server/src/lib/calendar-generator.ts` `createRoundRobinSchedule`: input list of team IDs (event_team ids), output array of rounds, each round an array of [home_team_id, away_team_id]. For N teams (N even): N-1 rounds, N/2 matches per round; fixed first team, rotate rest. No byes in Americano (N must be even: 6,8,10,12,14). New helper in `server/src/lib/` (e.g. `round-robin.ts`) or inline in API: pure function `createRoundRobinPairings(teamIds: string[]): { round_number: number; home_team_id: string; away_team_id: string }[]`.

---

## Classification Algorithm (Backend)

- Input: `event_id`.
- Load all `event_matches` for event with non-null `resultado_local` and `resultado_visitante`.
- For each `event_team` of the event, initialize: PJ=0, PG=0, PP=0, PF=0, PC=0.
- For each match:
  - If `resultado_local !== null && resultado_visitante !== null`: consider match played. Home team: PJ+=1, PF+=resultado_local, PC+=resultado_visitante; Away team: PJ+=1, PF+=resultado_visitante, PC+=resultado_local. If resultado_local > resultado_visitante: home PG+=1, away PP+=1; else if resultado_visitante > resultado_local: away PG+=1, home PP+=1. (No draws in Americano; PG/PP only.)
- DIF = PF - PC; PTS = PG (one point per win; tie-break: "Orden alfabético" by team name).
- Sort by: PTS descending, then team name ascending (alfabético).
- Return list of { team_id, team_name, PJ, PG, PP, PF, PC, DIF, PTS }.

---

## Frontend

### New Page and Route

**File**: `ui/src/pages/AdminEvents.tsx` (new)

- Admin-only page. List events (cards or table): name, type, team count, link to detail. Button "Crear evento" → create event flow (name) then redirect to event detail for adding teams.
- Event detail view (same page with `eventId` in route or separate page): title event name; section "Equipos" (teams): search players (reuse pattern from AdminPlayers or PlayerSearchModal), add pair as team (name + 2 players); show list of teams; allow remove team (only if no matches or per API). Button "Generar partidos" enabled when team count in {6,8,10,12,14}; on success, show rounds and matches.
- Section "Jornadas / Partidos": list by round; each match: local team name vs away team name, two inputs for resultado_local and resultado_visitante; on blur or save, call PUT match result; then refetch or recompute classification.
- Section "Clasificación": table columns Pos, Equipo, PJ, PG, PP, PF, PC, DIF, PTS. Data from GET classifications; no persistence. After editing a result, refetch GET classifications to update in real time.

**File**: `ui/src/App.tsx`
- Add route: `/admin/events` → `AdminEvents` (list); optionally `/admin/events/:eventId` → event detail (or single page with optional eventId).
- Protect with `AdminRoute`.

**File**: `ui/src/components/appSidebar.tsx`
- Add sidebar item for admins: label "Eventos" (or "Gestión de eventos"), link to `/admin/events`, icon (e.g. Trophy or CalendarDays). Insert with other admin links (after Ligas, Equipos, Jugadores, Panel de control).

### Server Comm

**File**: `ui/src/lib/serverComm.ts`

- `getEvents()` → GET `/api/v1/admin/events`
- `createEvent(name: string)` → POST `/api/v1/admin/events`
- `getEvent(eventId: string)` → GET `/api/v1/admin/events/:eventId`
- `updateEvent(eventId: string, body: { name?: string })` → PUT `/api/v1/admin/events/:eventId`
- `deleteEvent(eventId: string)` → DELETE `/api/v1/admin/events/:eventId`
- `addEventTeam(eventId: string, body: { name: string; user_ids: [string, string] })` → POST `/api/v1/admin/events/:eventId/teams`
- `removeEventTeam(eventId: string, teamId: string)` → DELETE `/api/v1/admin/events/:eventId/teams/:teamId`
- `generateEventMatches(eventId: string)` → POST `/api/v1/admin/events/:eventId/generate-matches`
- `getEventMatches(eventId: string)` → GET `/api/v1/admin/events/:eventId/matches`
- `updateEventMatchResult(eventId: string, matchId: string, body: { resultado_local?: number | null; resultado_visitante?: number | null })` → PUT `/api/v1/admin/events/:eventId/matches/:matchId`
- `getEventClassifications(eventId: string)` → GET `/api/v1/admin/events/:eventId/classifications`

### i18n

**File**: `ui/src/locales/...` (es/en) — add keys for "Eventos", "Crear evento", "Equipos", "Generar partidos", "Clasificación", column names (PJ, PG, PP, PF, PC, DIF, PTS), "Jornada", "Partidos", validation messages (team count must be 6, 8, 10, 12 or 14; team must have exactly 2 players).

---

## Round-Robin Algorithm (Detail)

- Input: array of `teamIds` (length N ∈ {6,8,10,12,14}).
- N-1 rounds; each round N/2 matches; total N*(N-1)/2 pairings; each pair (A,B) appears exactly once (either (A,B) or (B,A) for home/away).
- Standard circle method: fix team 0; rotate others. Round r (0-based): team at index 0 vs team at index N-1-r (with indices in rotating array); team 1 vs N-2-r; …; middle pair. Rotation: keep index 0 fixed; indices 1..N-1 rotate clockwise (e.g. last moves to second). Output list of { round_number, home_team_id, away_team_id }.

Reference implementation pattern: `server/src/lib/calendar-generator.ts` `createRoundRobinSchedule` (lines ~364–435). For even N only, no bye; numRounds = N-1; matches per round = N/2.

---

## Files Summary

| Area | File | Action |
|------|------|--------|
| Schema | `server/src/schema/events.ts` | Create (events, event_teams, event_team_members, event_matches; eventTypeEnum) |
| Schema | `server/src/schema/enums.ts` | Optional: add eventTypeEnum here or in events.ts |
| API | `server/src/api.ts` | Register event routes under admin; implement all 11 endpoints; import events schema |
| Lib | `server/src/lib/round-robin.ts` (or inline in api) | Create round-robin helper for event match generation |
| UI | `ui/src/pages/AdminEvents.tsx` | Create (list, create, detail, teams, matches, classifications) |
| UI | `ui/src/App.tsx` | Add route(s) /admin/events, /admin/events/:eventId |
| UI | `ui/src/components/appSidebar.tsx` | Add "Eventos" link for admins |
| UI | `ui/src/lib/serverComm.ts` | Add 11 API client functions |
| i18n | `ui/src/locales/es/...`, `ui/src/locales/en/...` | Add event-related strings |

---

## Validation Rules (Recap)

- Create Americano: name required.
- Add team: name required; exactly 2 `user_ids`; users must exist; optional: no duplicate user in same event across teams.
- Generate matches: team count must be 6, 8, 10, 12 or 14; idempotency: fail if matches already exist (or document overwrite behavior).
- Match result: non-negative integers; null to clear.

Classification: never stored; always computed from `event_matches`. Order: PTS desc, then team name asc (alfabético).
