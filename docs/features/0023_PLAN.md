# Remove Groups Concept - Direct League to Teams Relationship

## Context

The application currently has a three-level hierarchy: **Leagues → Groups → Teams**. We need to simplify this to a two-level hierarchy: **Leagues → Teams**. Groups will be completely removed from the system.

**Current Structure:**
- Leagues contain Groups
- Groups contain Teams (level and gender defined at group level)
- Matches belong to both League and Group

**New Structure:**
- Leagues contain Teams directly (level and gender will be defined at league level)
- Matches belong only to League

## Database Schema Changes

### 1. Remove Groups Table

**File**: `server/src/schema/leagues.ts`

- Remove the `groups` table definition
- Remove `Group` and `NewGroup` type exports
- Keep `leagues` and `matches` tables

### 2. Update Matches Table

**File**: `server/src/schema/leagues.ts`

- Remove `group_id` field from `matches` table
- Keep only `league_id` reference
- Update foreign key constraints

**Current:**
```typescript
export const matches = appSchema.table("matches", {
  id: text("id").primaryKey(),
  league_id: text("league_id").notNull().references(() => leagues.id),
  group_id: text("group_id").notNull().references(() => groups.id), // REMOVE THIS
  // ... rest
});
```

**New:**
```typescript
export const matches = appSchema.table("matches", {
  id: text("id").primaryKey(),
  league_id: text("league_id").notNull().references(() => leagues.id),
  // group_id removed
  // ... rest
});
```

### 3. Update Teams Table

**File**: `server/src/schema/teams.ts`

- Remove `group_id` field from `teams` table (already nullable, but remove completely)
- Keep `league_id` field
- Update imports to remove `groups` reference

**Current:**
```typescript
import { leagues, groups, levelEnum, genderEnum } from "./leagues";

export const teams = appSchema.table("teams", {
  // ...
  league_id: text("league_id"), // nullable
  group_id: text("group_id"), // nullable - REMOVE THIS
  // ...
});
```

**New:**
```typescript
import { leagues, levelEnum, genderEnum } from "./leagues"; // Remove groups

export const teams = appSchema.table("teams", {
  // ...
  league_id: text("league_id"), // keep this
  // group_id removed
  // ...
});
```

### 4. Database Migration

**File**: `server/drizzle/XXXX_remove_groups.sql` (new migration)

1. **Drop foreign key constraints:**
   ```sql
   ALTER TABLE "app"."matches" DROP CONSTRAINT IF EXISTS "matches_group_id_groups_id_fk";
   ALTER TABLE "app"."teams" DROP CONSTRAINT IF EXISTS "teams_group_id_groups_id_fk";
   ```

2. **Remove group_id columns:**
   ```sql
   ALTER TABLE "app"."matches" DROP COLUMN IF EXISTS "group_id";
   ALTER TABLE "app"."teams" DROP COLUMN IF EXISTS "group_id";
   ```

3. **Drop groups table:**
   ```sql
   DROP TABLE IF EXISTS "app"."groups";
   ```

4. **Data migration considerations:**
   - Teams with `group_id` but no `league_id`: Need to determine league from group's league_id
   - Matches: All matches should have valid `league_id`, group_id can be safely removed
   - Note: This migration will lose group-level data (group names, etc.) - acceptable for simplification

## Backend API Changes

### 1. Remove Group Management Endpoints

**File**: `server/src/api.ts`

**Remove these endpoints:**
- `POST /api/v1/admin/leagues/:leagueId/groups` - Create group
- `GET /api/v1/admin/leagues/:leagueId/groups` - List groups in league
- `PUT /api/v1/admin/groups/:id` - Update group
- `DELETE /api/v1/admin/groups/:id` - Delete group
- `GET /api/v1/leagues/:id/groups` - Public endpoint to get groups

### 2. Update League Endpoints

**File**: `server/src/api.ts`

**Modify `GET /api/v1/admin/leagues/:id`:**
- Remove the query that fetches groups
- Remove `groups` from the response
- Return league with teams directly (if needed)

**Current:**
```typescript
const leagueGroups = await db
  .select()
  .from(groups)
  .where(eq(groups.league_id, leagueId));

return c.json({
  league: { ...league, groups: leagueGroups },
  // ...
});
```

**New:**
```typescript
// Remove groups query entirely
return c.json({
  league: league,
  // ...
});
```

### 3. Update Calendar Generation

**File**: `server/src/api.ts`

**Modify `POST /api/v1/admin/groups/:groupId/generate-calendar`:**
- Change endpoint to: `POST /api/v1/admin/leagues/:leagueId/generate-calendar`
- Remove group lookup
- Get teams directly from league
- Pass `leagueId` to calendar generator instead of `groupId`

**File**: `server/src/lib/calendar-generator.ts`

**Update `CalendarGenerator` class:**
- Change `generateCalendar(groupId: string, startDate: Date)` to `generateCalendar(leagueId: string, startDate: Date)`
- Remove `validateInputs` group validation
- Update `getTeamAvailability` to query teams by `league_id` instead of `group_id`
- Update `saveMatches` to only save `league_id` (no `group_id`)

**Current:**
```typescript
async generateCalendar(groupId: string, startDate: Date) {
  await this.validateInputs(groupId, startDate);
  const teamAvailability = await this.getTeamAvailability(groupId);
  // ...
}

async getTeamAvailability(groupId: string) {
  // Query teams where group_id = groupId
}

async saveMatches(matches: GeneratedMatch[], leagueId: string, groupId: string) {
  // Save matches with both league_id and group_id
}
```

**New:**
```typescript
async generateCalendar(leagueId: string, startDate: Date) {
  await this.validateInputs(leagueId, startDate);
  const teamAvailability = await this.getTeamAvailability(leagueId);
  // ...
}

async getTeamAvailability(leagueId: string) {
  // Query teams where league_id = leagueId
}

async saveMatches(matches: GeneratedMatch[], leagueId: string) {
  // Save matches with only league_id (no group_id)
}
```

### 4. Update Calendar Retrieval

**File**: `server/src/api.ts`

**Modify `GET /api/v1/admin/groups/:groupId/calendar`:**
- Change endpoint to: `GET /api/v1/admin/leagues/:leagueId/calendar`
- Query matches by `league_id` instead of `group_id`

**Current:**
```typescript
const groupMatches = await db
  .select()
  .from(matches)
  .where(eq(matches.group_id, groupId))
```

**New:**
```typescript
const leagueMatches = await db
  .select()
  .from(matches)
  .where(eq(matches.league_id, leagueId))
```

### 5. Remove Group Imports and Types

**File**: `server/src/api.ts`

- Remove `groups` import from schema
- Remove `NewGroup`, `Group` type imports
- Remove `NewGroup`, `UpdateGroup` type definitions
- Remove group-related error handling (e.g., `groups_league_id_name_unique`)

### 6. Update Error Handling

**File**: `server/src/api.ts`

- Remove group-related constraint error handling from `handleDatabaseError` function

## Frontend API Client Changes

### 1. Remove Group Types and Functions

**File**: `ui/src/lib/serverComm.ts`

**Remove:**
- `Group` interface
- `NewGroup` interface
- `UpdateGroup` interface
- `getGroups(leagueId: string)` function
- `createGroup(leagueId: string, data: NewGroup)` function
- `updateGroup(id: string, data: UpdateGroup)` function
- `deleteGroup(id: string)` function

### 2. Update Calendar Generation Functions

**File**: `ui/src/lib/serverComm.ts`

**Modify:**
- `generateGroupCalendar(groupId: string, startDate: string)` → `generateLeagueCalendar(leagueId: string, startDate: string)`
- `getGroupCalendar(groupId: string)` → `getLeagueCalendar(leagueId: string)`

**Update endpoint URLs:**
- `/api/v1/admin/groups/:groupId/generate-calendar` → `/api/v1/admin/leagues/:leagueId/generate-calendar`
- `/api/v1/admin/groups/:groupId/calendar` → `/api/v1/admin/leagues/:leagueId/calendar`

## Frontend UI Changes

### 1. Remove Group Management Pages

**Files to remove or update:**
- `ui/src/pages/AdminTeams.tsx` - This appears to be a group detail page, needs significant refactoring
- Any group-specific routing in `App.tsx`

### 2. Update AdminLeagues Page

**File**: `ui/src/pages/AdminLeagues.tsx`

**Changes:**
- Remove "Groups" button from league cards
- Remove group navigation (`/admin/teams` route)
- Add direct team management for each league
- Update league detail view to show teams directly instead of groups
- Remove group-related translation keys usage

**Current flow:**
```
League Card → Click "Groups" → AdminTeams page (shows groups)
```

**New flow:**
```
League Card → Click "Teams" → Show teams directly in league detail view
```

### 3. Update League Detail View

**File**: `ui/src/pages/AdminLeagues.tsx` (or new component)

**Add:**
- Teams list section for each league
- Team creation/management within league context
- Calendar generation button for league (not group)
- Calendar display for league matches

### 4. Update Calendar Generation Component

**File**: `ui/src/components/GenerateCalendarModal.tsx`

**Changes:**
- Update props: `groupId` → `leagueId`
- Update API calls to use `generateLeagueCalendar`
- Update labels and messages to refer to "league" instead of "group"

**Current:**
```typescript
interface GenerateCalendarModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  groupId: string;
  onCalendarGenerated?: () => void;
}
```

**New:**
```typescript
interface GenerateCalendarModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  leagueId: string;
  onCalendarGenerated?: () => void;
}
```

### 5. Update Calendar Display Component

**File**: `ui/src/components/GroupCalendar.tsx`

**Changes:**
- Rename to `LeagueCalendar.tsx` or update props
- Update props: `groupId` → `leagueId`
- Update API calls to use `getLeagueCalendar`
- Update component name and all references

### 6. Remove Group References from Routes

**File**: `ui/src/App.tsx`

**Changes:**
- Remove routes that navigate to group pages
- Update navigation to go directly to league teams

### 7. Update Translation Files

**Files**: `ui/src/locales/en/leagues.json`, `ui/src/locales/es/leagues.json`

**Remove or deprecate:**
- All group-related translation keys (can keep for now if referenced elsewhere, but mark as deprecated)

**Update:**
- "Manage groups" → "Manage teams"
- "Create group" → "Create team"
- Any group-related labels in league management

## Data Migration Strategy

### Phase 1: Backward Compatibility (Optional - if data needs preservation)

1. Before removing groups, migrate data:
   - Teams: If team has `group_id` but no `league_id`, set `league_id` from group's `league_id`
   - Matches: Ensure all matches have valid `league_id` (they should already)

### Phase 2: Schema Update

1. Run migration to drop group_id columns and groups table
2. Verify all data is correctly linked via league_id

## Testing Checklist

1. **Database:**
   - [ ] Migration runs successfully
   - [ ] No orphaned data (teams without league, matches without league)
   - [ ] Foreign key constraints work correctly

2. **Backend API:**
   - [ ] League endpoints return data without groups
   - [ ] Calendar generation works with leagueId
   - [ ] Calendar retrieval works with leagueId
   - [ ] No group endpoints accessible

3. **Frontend:**
   - [ ] League list displays correctly
   - [ ] League detail shows teams directly
   - [ ] Team management works within league context
   - [ ] Calendar generation works from league view
   - [ ] Calendar display shows league matches
   - [ ] No broken links or references to groups

## Rollback Plan

If issues arise:
1. Keep migration reversible (DROP IF EXISTS, ADD IF NOT EXISTS)
2. Document original schema structure
3. Can restore groups table and foreign keys if needed

## Notes

- **Matches table**: Currently requires both `league_id` and `group_id`. After migration, only `league_id` is needed.
- **Team filtering**: Previously done by group (level + gender). Now filtering should be done at league level or team query level.
- **Calendar generation**: Logic remains the same, just operates on league teams instead of group teams.

