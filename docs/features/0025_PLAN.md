# Move Player Payments UI from Admin Teams to Admin Leagues

## Overview

Move the player payment UI from the admin teams page to the admin leagues page. Since player payments are per league, the payment management interface should be displayed in the team member collapsible list on the admin leagues page. This consolidates payment management within the league context where teams and their members are already organized.

## Technical Requirements

### Backend Changes

**File: `server/src/api.ts`**

1. **Update GET `/admin/leagues/:leagueId/teams` endpoint**:
   - Currently returns teams with member counts only (lines 781-810)
   - Update to include full member data with payment information
   - Query should include:
     - Team information (existing)
     - League information (existing)
     - Creator information (existing)
     - Member count (existing)
     - **NEW**: Full member list for each team with:
       - Member data (`team_members`: `id`, `paid`, `paid_at`, `paid_amount`, `joined_at`)
       - User data (`users`: `id`, `email`, `first_name`, `last_name`, `display_name`, `profile_picture_url`, `gender`)
   - Structure should match the format returned by `/admin/teams` endpoint for consistency
   - Example response structure:
     ```json
     {
       "teams": [
         {
           "team": { ... },
           "league": { ... },
           "creator": { ... },
           "member_count": 5,
           "members": [
             {
               "member": { "id", "paid", "paid_at", "paid_amount", ... },
               "user": { "id", "email", "first_name", ... }
             }
           ]
         }
       ]
     }
     ```

### Frontend Changes

**File: `ui/src/pages/AdminLeagues.tsx`**

1. **Update state management**:
   - The `leagueTeamsMap` state already exists (line 82) but needs to handle the new structure with members
   - Add state for payment dialog:
     - `showPaymentDialog`: boolean
     - `paymentTeamId`: string | null
     - `paymentUserId`: string | null
     - `paymentLeagueId`: string | null (to track which league the payment is for)
     - `paymentAmount`: string
     - `paymentError`: string

2. **Update `loadLeagueTeams` function** (around line 242):
   - Function already calls `api.getAdminTeamsByLeague(leagueId)`
   - No changes needed if backend returns the new structure
   - Ensure the response structure with members is handled correctly

3. **Add payment management functions**:
   - `handleMarkPaid(teamId: string, userId: string, leagueId: string, currentPaid: boolean, desiredPaid: boolean)`: 
     - Handles switching between paid/unpaid states
     - Opens payment dialog when marking as paid
     - Calls API to update payment status
   - `handlePaymentDialogConfirm()`: 
     - Validates payment amount
     - Calls `api.updateMemberPaid(teamId, userId, { paid: true, paid_amount: amount })`
     - Refreshes league teams after successful update
     - Closes dialog and resets state

4. **Update team member display in collapsible list**:
   - Currently only shows team name and member count (lines 460-486)
   - **Expand to show individual team members** when a team is clicked/expanded
   - Add a nested collapsible or expandable section for each team's members
   - For each member, display:
     - User avatar (using `UserAvatar` component)
     - User name/email
     - Gender icon (Mars/Venus) if applicable
     - Payment status indicator (CheckCircle2/XCircle with color coding)
     - Payment switch (Switch component) to toggle paid/unpaid
     - When paid: display payment amount and date below the switch
   - Use the same UI pattern as AdminTeams page (lines 533-626) for consistency

5. **Add payment dialog**:
   - Reuse the same Dialog component pattern from AdminTeams (lines 640-683)
   - Dialog should:
     - Display title: "Mark as paid" (translated)
     - Input field for payment amount (numeric, required)
     - Error message display area
     - Cancel and Confirm buttons
     - On confirm: call `handlePaymentDialogConfirm`

6. **Update imports**:
   - Add `Switch` component from `@/components/ui/switch`
   - Add `Tooltip`, `TooltipTrigger`, `TooltipContent` from `@/components/ui/tooltip`
   - Add `UserAvatar` component from `@/components/user-avatar`
   - Add icons: `CheckCircle2`, `XCircle`, `Mars`, `Venus` from `lucide-react`
   - Ensure `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogFooter`, `DialogDescription` are imported
   - Ensure `Input` component is imported

**File: `ui/src/lib/serverComm.ts`**

1. **Update `getAdminTeamsByLeague` function** (around line 370):
   - Function signature remains the same
   - Return type should include members array in the response
   - Update TypeScript interface if needed to reflect the new response structure

2. **Ensure `updateMemberPaid` function exists** (already exists around line 350):
   - Function signature: `updateMemberPaid(teamId: string, userId: string, payload: { paid: boolean; paid_at?: string; paid_amount?: number })`
   - No changes needed - this function is already used by AdminTeams

### Remove from AdminTeams Page

**File: `ui/src/pages/AdminTeams.tsx`**

1. **Remove payment-related UI elements**:
   - Remove payment status filter (lines 269-278)
   - Remove payment switches and indicators from member display (lines 507-623)
   - Remove payment dialog (lines 640-683)
   - Remove payment-related state variables (lines 48-54)
   - Remove `handleMarkPaid` function (lines 148-171)
   - Remove `handlePaymentDialogConfirm` function (lines 173-188)
   - Remove payment-related imports (Switch, Dialog for payment, etc.) if not used elsewhere

2. **Update `loadTeams` function**:
   - Remove payment status filtering logic (lines 309-324)
   - Keep team filtering by level, gender, and name query

3. **Update member display**:
   - Remove payment status indicators and switches
   - Keep user avatar, name, email, gender icon display
   - Simplify member card to show only user information

### Internationalization

**Files: `ui/src/locales/en/leagues.json` and `ui/src/locales/es/leagues.json`**

1. **Add translation keys** (if not already present):
   - `"markPaid"`: "Mark as paid" / "Marcar como pagado"
   - `"amountPaid"`: "Amount paid" / "Cantidad pagada"
   - `"paid"`: "Paid" / "Pagado" (may already exist in teams.json, check if can be reused)
   - Payment-related messages from teams.json may need to be moved to leagues.json or kept in teams.json for reuse

**Files: `ui/src/locales/en/teams.json` and `ui/src/locales/es/teams.json`**

1. **Keep payment-related translations**:
   - These can be reused by AdminLeagues page
   - Or move to common.json if used across multiple pages

### Algorithm

1. **Loading league teams with members**:
   - User expands a league's teams collapsible section
   - `handleToggleTeams` is called (already exists, line 258)
   - `loadLeagueTeams` is called if teams not already loaded
   - Backend returns teams with full member data including payment info
   - Teams are displayed with member counts

2. **Expanding team to show members**:
   - User clicks on a team in the league's team list
   - Team expands to show nested list of members
   - Each member shows payment status, switch, and payment details if paid

3. **Marking a member as paid**:
   - Admin toggles payment switch to "paid"
   - `handleMarkPaid` is called with teamId, userId, leagueId, current status, and desired status
   - Payment dialog opens
   - Admin enters payment amount
   - Admin clicks confirm
   - `handlePaymentDialogConfirm` validates amount and calls API
   - On success: dialog closes, league teams are refreshed to show updated payment status

4. **Marking a member as unpaid**:
   - Admin toggles payment switch to "unpaid"
   - `handleMarkPaid` is called
   - API is called immediately with `paid: false` (no dialog needed)
   - League teams are refreshed to show updated status

### Files to Modify

- `server/src/api.ts`: Update GET `/admin/leagues/:leagueId/teams` endpoint to include member data
- `ui/src/pages/AdminLeagues.tsx`: Add payment UI components, state, and handlers
- `ui/src/pages/AdminTeams.tsx`: Remove payment-related UI and logic
- `ui/src/lib/serverComm.ts`: Update TypeScript interfaces if needed for new response structure
- `ui/src/locales/en/leagues.json`: Add payment-related translations if needed
- `ui/src/locales/es/leagues.json`: Add payment-related translations if needed

### Implementation Notes

- The payment data structure remains the same (stored in `team_members` table with `paid`, `paid_at`, `paid_amount` fields)
- Payments are effectively "per league" because teams belong to leagues, and members belong to teams
- The API endpoint `/admin/teams/:teamId/members/:userId/paid` remains unchanged and can be reused
- The UI should maintain consistency with the existing AdminTeams payment UI patterns
- Consider using a nested collapsible or accordion pattern for teams within the league's collapsible section
- Ensure proper loading states when fetching member data
- Handle edge cases: teams with no members, users with missing data, etc.

