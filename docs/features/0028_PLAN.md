# League Calendar and Classifications Page

## Description

Add a "Calendar and Classifications" action button to league cards in the admin leagues page. The button is icon-only (no text) for space efficiency. Clicking the button navigates to a new page that displays the league calendar (match schedule) and classifications (standings table). Initially, when no calendar exists, the page provides a button to generate the calendar using an enhanced round-robin algorithm that considers team availability, player match conflicts, weekly scheduling constraints, and home/away alternation.

## Files to Modify

### Frontend Components

**File**: `ui/src/pages/AdminLeagues.tsx`
- Add new icon button in `CardFooter` (around line 660-686) next to existing action buttons (Edit, Delete)
- Button should use a calendar/table icon (e.g., `Calendar` or `Table` from lucide-react)
- Button navigates to `/admin/leagues/:leagueId/calendar-classifications`
- Use `Tooltip` component to show "Calendar and Classifications" on hover since button has no text

**File**: `ui/src/pages/LeagueCalendarClassifications.tsx` (new)
- Create new page component for displaying calendar and classifications
- Display two main sections:
  1. **Calendar Section**: Shows all matches grouped by week, with date, time, home team, away team
  2. **Classifications Section**: Shows standings table with team name, matches played, wins, draws, losses, goals for, goals against, goal difference, points
- If no matches exist, show "Generate Calendar" button
- Button triggers calendar generation modal/dialog with start date picker
- After generation, display calendar and classifications

**File**: `ui/src/App.tsx`
- Add route: `/admin/leagues/:leagueId/calendar-classifications` → `LeagueCalendarClassifications` component
- Protect route with admin middleware

**File**: `ui/src/lib/serverComm.ts`
- Add function `generateLeagueCalendar(leagueId: string, startDate: string)` - calls `POST /api/v1/admin/leagues/:leagueId/generate-calendar`
- Add function `getLeagueCalendar(leagueId: string)` - calls `GET /api/v1/admin/leagues/:leagueId/calendar`
- Add function `getLeagueClassifications(leagueId: string)` - calls `GET /api/v1/admin/leagues/:leagueId/classifications`
- Add function `updateMatchDate(leagueId: string, matchId: string, date: string, time: string)` - calls `PUT /api/v1/admin/leagues/:leagueId/matches/:matchId/date`

### Backend API

**File**: `server/src/api.ts`
- Enhance existing `POST /api/v1/admin/leagues/:leagueId/generate-calendar` endpoint (around line 2298)
  - Use enhanced calendar generator with conflict detection
  - Check for existing player matches across all leagues before scheduling
- Add new `GET /api/v1/admin/leagues/:leagueId/classifications` endpoint
  - Calculate standings from matches (wins, draws, losses, goals, points)
  - Return teams ordered by points (desc), then goal difference (desc), then goals for (desc)
- Add new `PUT /api/v1/admin/leagues/:leagueId/matches/:matchId/date` endpoint
  - Allow admin to manually assign date/time when automatic scheduling fails
  - Validate date is within league start_date and end_date
- Enhance existing `GET /api/v1/admin/leagues/:leagueId/calendar` endpoint (around line 2357)
  - Ensure it returns matches with all necessary data for display

### Calendar Generator Enhancement

**File**: `server/src/lib/calendar-generator.ts`
- Enhance `scheduleMatches` method (around line 222) to implement new requirements:
  1. **Check player match conflicts**: Before scheduling a match, query all existing matches for players in both teams to ensure no player has another match on the same day
  2. **Weekly scheduling**: Ensure one match per week per team when possible; if not possible, assign bye weeks
  3. **Home/away alternation**: Track home/away status per team and alternate between weeks
  4. **Team matching priority**: If teams cannot be matched due to availability conflicts:
     - First priority: Team that meets minimum availability requirement (most available days)
     - Second priority: Team with most availability if no team meets minimum
     - Fallback: Mark match as needing manual assignment (return special flag or null date)
- Add new method `checkPlayerMatchConflicts(team1Id: string, team2Id: string, proposedDate: Date): Promise<boolean>`
  - Query `team_members` to get all players for both teams
  - Query `matches` table to find matches on the same date involving any of these players
  - Return `true` if conflict exists, `false` otherwise
- Enhance `findBestMatchTimeWithConflictAvoidance` method (around line 340) to:
  - Accept team IDs in addition to TeamAvailability objects
  - Call `checkPlayerMatchConflicts` before selecting a date
  - Skip conflicting dates
- Modify return type to include matches that need manual assignment:
  - Add `needsManualAssignment: boolean` field to `GeneratedMatch` interface
  - Return array of matches, some with `needsManualAssignment: true` and `match_date: null`

### Database Schema

**File**: `server/src/schema/leagues.ts`
- No schema changes needed - `matches` table already exists with required fields
- Note: Classification calculation will be done in-memory from match results (when results are added in future)

## Implementation Details

### Calendar Generation Algorithm Enhancements

**Step 1: Round-Robin Schedule Creation**
- Use existing `createRoundRobinSchedule` method (line 278)
- Ensure each team plays every other team exactly once
- Handle odd number of teams with bye weeks

**Step 2: Conflict Detection for Each Match**
- For each match in the schedule:
  1. Get team availability for both teams
  2. Find common available days and time slots
  3. For each potential date/time:
     - Check if any player from home team has another match on that date
     - Check if any player from away team has another match on that date
     - Skip if conflict found
  4. If no conflict-free date found with availability:
     - Apply priority rules:
       - Check which team meets minimum availability (e.g., 2+ days available)
       - If both meet minimum, choose team with most availability
       - If neither meets minimum, mark for manual assignment

**Step 3: Home/Away Alternation**
- Track home/away status per team across weeks
- Alternate: if team was home last week, make them away this week (or vice versa)
- For first match, assign home/away randomly or based on some criteria (e.g., team creation order)

**Step 4: Weekly Distribution**
- Schedule one match per week per team when possible
- If team cannot be scheduled (due to conflicts or bye), assign bye for that week
- Ensure no team plays more than once per week

**Step 5: Manual Assignment Fallback**
- When automatic scheduling fails, return match with `needsManualAssignment: true`
- Admin can manually assign date/time via UI
- Store matches with `match_date: null` or special flag until admin assigns

### Classifications Calculation

**Algorithm** (implemented in API endpoint):
1. Get all matches for the league where results exist (future: when match results are added)
2. For each team in the league:
   - Initialize: matches_played = 0, wins = 0, draws = 0, losses = 0, goals_for = 0, goals_against = 0
   - For each match where team participated:
     - If home team: check `home_score` and `away_score`
     - If away team: check `away_score` and `home_score`
     - Update wins/draws/losses based on scores
     - Update goals_for and goals_against
   - Calculate: goal_difference = goals_for - goals_against, points = (wins * 3) + draws
3. Sort teams by: points (desc), goal_difference (desc), goals_for (desc)
4. Assign position/rank

**Note**: Initially, classifications will show all teams with zero stats since match results don't exist yet. This prepares the UI for when results are added.

### UI Layout

**LeagueCalendarClassifications Page Structure**:
```
┌─────────────────────────────────────────┐
│ League Name - Calendar & Classifications │
├─────────────────────────────────────────┤
│                                         │
│ [Generate Calendar Button] (if no matches) │
│                                         │
│ CALENDAR SECTION                        │
│ ┌─────────────────────────────────────┐ │
│ │ Week 1                              │ │
│ │ - Sat, Jan 1, 10:00 - Team A vs Team B │
│ │ - Sat, Jan 1, 11:00 - Team C vs Team D │
│ │ Week 2                              │ │
│ │ ...                                 │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ CLASSIFICATIONS SECTION                 │
│ ┌─────────────────────────────────────┐ │
│ │ Pos │ Team │ MP │ W │ D │ L │ GF │ GA │ GD │ Pts │
│ │  1  │ Team A│  0 │ 0 │ 0 │ 0 │  0 │  0 │  0 │   0 │
│ │  2  │ Team B│  0 │ 0 │ 0 │ 0 │  0 │  0 │  0 │   0 │
│ └─────────────────────────────────────┘ │
│                                         │
│ [Matches needing manual assignment]     │
│ (if any)                                │
└─────────────────────────────────────────┘
```

### Match Conflict Detection Query

**Implementation in `checkPlayerMatchConflicts`**:
```sql
SELECT COUNT(*) 
FROM app.matches m
JOIN app.team_members tm1 ON m.home_team_id = tm1.team_id OR m.away_team_id = tm1.team_id
JOIN app.team_members tm2 ON (tm2.team_id = :team1Id OR tm2.team_id = :team2Id) AND tm2.user_id = tm1.user_id
WHERE DATE(m.match_date) = DATE(:proposedDate)
```

This finds matches on the proposed date where any player from team1 or team2 is already scheduled.

## Algorithm Flow

### Enhanced Calendar Generation Flow

1. **Validate inputs**: League exists, has teams, teams have availability
2. **Get team availability**: Fetch all teams with their availability data
3. **Generate round-robin pairs**: Create all team pairs (n choose 2)
4. **Create weekly schedule**: Distribute pairs across weeks (one match per team per week)
5. **For each match in schedule**:
   a. Get home and away team availability
   b. Find common available days/times
   c. For each potential date/time:
      - Check player match conflicts
      - If conflict, skip to next date
      - If no conflict, check home/away alternation
      - If valid, assign date/time and break
   d. If no valid date found:
      - Apply priority: minimum availability requirement → most availability → manual assignment
   e. Track home/away status for next week
6. **Return generated matches**: Include matches with `needsManualAssignment` flag
7. **Save matches**: Insert into database, matches needing assignment have `match_date: null`

### Manual Assignment Flow

1. Admin clicks on match marked for manual assignment
2. Date/time picker dialog opens
3. Admin selects date and time
4. API validates: date within league start/end dates, no conflicts with player's other matches
5. Update match with assigned date/time
6. Refresh calendar display

