# Eventos: fecha/descripción y página jugadores (ver eventos y apuntarse)

## Description

Two parts:

1. **Events must have a start date and a description (can be empty).** Extend the events model and admin flows accordingly.

2. **New player-facing page** where players can see available events and sign up. Two sign-up options:
   - **De forma individual:** the player is added to the event and remains "a la espera de formar parte de un equipo para participar" (waiting to be part of a team to participate).
   - **Como equipo:** the player has a player search to find their partner ("buscador de jugadores para buscar su pareja"); once the partner is selected, the user is asked for a team name; on submit, both are added as participants and the team is added to the event.

---

## Phase 1 — Data layer

### Schema changes

**File:** `server/src/schema/events.ts`

- **Table `events`:** add two columns:
  - `start_date` — date (e.g. `date("start_date")` in Drizzle) or timestamp; not null. Represents "fecha de inicio" of the event.
  - `description` — text, nullable (puede estar vacía).

**Migrations:** New Drizzle migration adding `start_date` and `description` to `events`. Use `ALTER TABLE ... ADD COLUMN` with defaults if needed (e.g. `start_date` default to `created_at` or require backfill; `description` default `''` or null). Make migration idempotent (e.g. `ADD COLUMN IF NOT EXISTS` where supported, or catch duplicate-column errors).

---

## Phase 2 — Backend API

**File:** `server/src/api.ts`

### Admin event endpoints (existing)

- **POST /api/v1/admin/events** — Extend body to accept `start_date` (ISO date string) and optional `description`. Validate `start_date` present. Persist both. Create flow already uses `NewEvent`; extend type/insert to include new fields.
- **PUT /api/v1/admin/events/:eventId** — Allow updating `start_date` and `description` in the body. Include in `updates` and persist.
- **GET /api/v1/admin/events** — Include `start_date` and `description` in each event in the list response (select already returns full row once schema is updated).
- **GET /api/v1/admin/events/:eventId** — Response already returns `event: ev`; `ev` will include `start_date` and `description` after schema change.

No new admin routes. Only extend request/response shapes and validation for the new fields.

### Protected (player) event endpoints — new

All under `protectedRoutes`, so authenticated user is required. Use `c.get("user")` for current user id.

1. **GET /api/v1/protected/events**
   - List events for the player view ("eventos disponibles").
   - Return array of events with: `id`, `name`, `tipo_evento`, `start_date`, `description`, `created_at`.
   - For each event, include the current user’s status so the UI can show "apuntarse individual", "apuntarse por equipos", or "ya inscrito":
     - If current user is not in `event_participants` for this event: e.g. `current_user_status: null` (or absent).
     - If current user is participant but not in any `event_team` for this event: `current_user_status: "participant_without_team"` (a la espera de equipo).
     - If current user is in an event team: `current_user_status: "participant_in_team"`, and include e.g. `team_name` (and optionally `team_id`) for that team.
   - Implementation: select events (with `start_date`, `description`); for each event, check `event_participants` for current user; if present, check `event_team_members` via `event_teams` for this event to see if user is in a team and get team name. Order by `start_date` asc or `created_at` desc as desired (e.g. upcoming first).

2. **POST /api/v1/protected/events/:eventId/join**
   - Join the event as an individual ("apuntarse de forma individual").
   - Current user is added to `event_participants` for `eventId`.
   - Validations: event exists; event has no generated matches yet (no rows in `event_matches` for this event), so sign-up is still open; current user is not already a participant; current user is not an admin (same rule as admin add-participant). On success return e.g. `{ participant: { user_id } }` or 201.

3. **POST /api/v1/protected/events/:eventId/join-as-team**
   - Body: `{ partner_user_id: string, team_name: string }`.
   - Join as a team: current user (inviter) + partner. Both become participants; one new event team is created with both as members.
   - Validations: event exists; event has no generated matches; `partner_user_id` is a valid user and not admin; `team_name` trimmed and non-empty; team name unique within the event (`event_teams` for this `event_id`); current user is not already in a team in this event; partner is not already in a team in this event. Optionally: if partner is not yet a participant, allow it and add them as part of this flow (so both end up in `event_participants` and in the new team).
   - Implementation: (1) Ensure both current user and partner are in `event_participants` (insert if missing, same as admin add-participant logic). (2) Ensure neither is in any `event_team` for this event (check `event_team_members`). (3) Insert one row in `event_teams` with `team_name`. (4) Insert two rows in `event_team_members` for the two user ids. Return e.g. `{ team }` 201.

4. **GET /api/v1/protected/players/search-by-name** (or equivalent for "buscador de jugadores" for partner)
   - Query param: `q` (search string). Require at least 3 characters to avoid huge result sets.
   - Return list of players (id, first_name, last_name, email) matching `q` (e.g. by name or email), excluding the current user. Used in the "apuntarse por equipos" flow to search for a partner. Do not return admins if the rest of the app treats them as non-players, or document that admins are excluded. Implementation: select from `users` where role is player (or not admin), and where first_name, last_name, or email ilike/like `%q%`; exclude current user id; limit results (e.g. 20).

---

## Phase 3 — Frontend

### Admin: event start date and description

**Files:** `ui/src/pages/AdminEvents.tsx`, `ui/src/lib/serverComm.ts` (api types and calls).

- **Create event:** In the create-event dialog/form, add required field "Fecha de inicio" (start date) and optional "Descripción" (description). Send `start_date` (e.g. ISO date string) and `description` in POST body to create event. Use date input or similar.
- **Event list/detail:** Display `start_date` and `description` where event info is shown (list row and/or detail header). Optional: allow editing `start_date` and `description` in event detail (if there is an edit event form); call PUT with updated fields.
- **serverComm:** Extend `createEvent` (or equivalent) to accept and send `start_date` and `description`. Extend types for event list/detail to include `start_date` and `description`.

### New player page: "Eventos" (available events and sign-up)

**New file:** `ui/src/pages/Events.tsx` (or `PlayerEvents.tsx`). Route: e.g. `/events` (or `/eventos`). Accessible to all authenticated users (not only admins); add link in sidebar for logged-in users so players can see it.

**Behaviour:**

- **List:** Fetch GET /api/v1/protected/events. Show each event with name, start_date, description (if any). For each event, use `current_user_status` to show:
  - Not participant: show two actions — "Apuntarse individual" and "Apuntarse por equipos".
  - Participant without team: show message like "Ya estás apuntado. A la espera de formar parte de un equipo." (no extra action required, or optional future: "Formar equipo" that goes to team flow).
  - Participant in team: show "Inscrito en equipo [team_name]".

- **Apuntarse de forma individual:** Button "Apuntarse individual" for that event. On click: confirm (optional); call POST /api/v1/protected/events/:eventId/join. On success: toast/confirmation; refresh list so status becomes "participant_without_team".

- **Apuntarse por equipos:** Button "Apuntarse por equipos" opens a flow (modal or inline):
  1. **Buscador de jugadores:** Input to search for partner. Require at least 3 characters; call GET /api/v1/protected/players/search-by-name?q=... and show results (name, email). User selects one player as "pareja".
  2. **Nombre del equipo:** Input for team name. Required.
  3. **Enviar:** On submit, call POST /api/v1/protected/events/:eventId/join-as-team with `{ partner_user_id: selectedPartnerId, team_name: teamName }`. On success: toast; refresh list; close modal. On error (e.g. partner already in team, name duplicate): show error message.

**Navigation and i18n:**

- **App.tsx:** Add route for `/events` (or chosen path) rendering the new page, inside the authenticated layout (no AdminRoute). No admin check.
- **appSidebar.tsx:** Add a sidebar item for "Eventos" (or "Eventos disponibles") visible to logged-in users (e.g. for all users, or only non-admin; decide if admins also see this list — typically yes so they can test). Link to `/events`.
- **Locales:** Add keys for the new page (event list title, "Apuntarse individual", "Apuntarse por equipos", "Buscar pareja", "Nombre del equipo", "A la espera de equipo", "Inscrito en equipo", errors, etc.) in the appropriate namespace (e.g. `events` or a new `playerEvents`).

**File:** `ui/src/lib/serverComm.ts`

- Add `getProtectedEvents()` → GET /api/v1/protected/events; type the response (events array with `current_user_status`, `team_name`, etc.).
- Add `joinEvent(eventId)` → POST /api/v1/protected/events/:eventId/join.
- Add `joinEventAsTeam(eventId, { partner_user_id, team_name })` → POST /api/v1/protected/events/:eventId/join-as-team.
- Add `searchPlayersByName(q)` → GET /api/v1/protected/players/search-by-name?q=...; type the response (array of players with id, first_name, last_name, email).

---

## Algorithm summary

- **GET protected/events:** For each event, compute `current_user_status` by: (1) query `event_participants` for (event_id, current_user_id); (2) if not found → null; (3) if found, query `event_team_members` joined with `event_teams` for this event and current_user_id; (4) if not in any team → "participant_without_team"; (5) if in a team → "participant_in_team" and team_name.
- **POST join-as-team:** In one transaction or sequential steps: (1) Insert current user and partner into `event_participants` if not present (ignore duplicate key). (2) Check neither is in an existing team. (3) Insert `event_teams` row. (4) Insert two `event_team_members` rows. Return the created team.

---

## Files to touch (summary)

| Area | File | Change |
|------|------|--------|
| Data | `server/src/schema/events.ts` | Add `start_date`, `description` to `events` table |
| Data | `server/drizzle/` | New migration for new columns |
| API | `server/src/api.ts` | Admin: extend create/update/list event with start_date, description; add protected GET /events, POST /events/:id/join, POST /events/:id/join-as-team, GET /players/search-by-name |
| UI | `ui/src/pages/AdminEvents.tsx` | Add start_date and description to create/edit and display |
| UI | `ui/src/pages/Events.tsx` (new) | New page: list events, individual join, team join flow with partner search and team name |
| UI | `ui/src/App.tsx` | Route for /events |
| UI | `ui/src/components/appSidebar.tsx` | Link "Eventos" for logged-in users |
| UI | `ui/src/lib/serverComm.ts` | New API functions and types for protected events and search-by-name |
| UI | `ui/src/locales/` (es/en) | New strings for player events page and forms |
