# Player Level Validation System Plan

## Overview

Implement a player level validation system where players can define their level in their profile, but the change remains pending until an administrator validates it. Players can see their validation status next to their level, and administrators have a dedicated page to review and approve/reject level change requests.

## Technical Requirements

### Database Schema Changes

**File**: `server/src/schema/users.ts` (modify existing)

- Add new fields to `users` table:
  - `claimed_level` (levelEnum, nullable) - The level the player has claimed
  - `level_validation_status` (pgEnum with values: "none", "pending", "approved", "rejected") - Validation status
  - `level_validated_at` (timestamp, nullable) - When the level was last validated
  - `level_validated_by` (text, nullable, foreign key to users.id) - Which admin validated the level
  - `level_validation_notes` (text, nullable) - Optional notes from admin

**File**: `server/drizzle/0003_add_level_validation.sql` (new migration file)

- Create `level_validation_status` enum with values: "none", "pending", "approved", "rejected"
- Add new columns to `app.users` table for level validation system
- Add foreign key constraint for `level_validated_by` referencing `users.id`

### API Implementation

**File**: `server/src/api.ts` (modify existing)

- Add new admin-protected endpoints:
  - `GET /api/v1/admin/level-validations` - Get all pending level validation requests
  - `POST /api/v1/admin/level-validations/:userId/approve` - Approve a level validation request
  - `POST /api/v1/admin/level-validations/:userId/reject` - Reject a level validation request
- Add new player endpoints:
  - `PUT /api/v1/protected/profile/level` - Update player's claimed level (sets status to "pending")
  - `GET /api/v1/protected/profile/level-status` - Get current level validation status

**File**: `ui/src/lib/serverComm.ts` (modify existing)

- Add new API functions:
  - `getLevelValidationRequests()` - Fetch pending validation requests for admin
  - `approveLevelValidation(userId, notes?)` - Approve a level validation
  - `rejectLevelValidation(userId, notes?)` - Reject a level validation
  - `updatePlayerLevel(level)` - Update player's claimed level
  - `getPlayerLevelStatus()` - Get player's current level validation status

### User Profile Updates

**File**: `ui/src/pages/Profile.tsx` (modify existing)

- Add level selection section with:
  - Dropdown to select level (1-4) using existing level enum
  - Display current validation status with visual indicators:
    - "None" - No level claimed (default state)
    - "Pending" - Level claimed, awaiting admin validation (yellow/orange indicator)
    - "Approved" - Level validated by admin (green indicator)
    - "Rejected" - Level rejected by admin (red indicator)
  - Show admin notes if level was rejected
  - Disable level changes while validation is pending
  - Show timestamp of last validation

**File**: `ui/src/lib/serverComm.ts` (modify existing)

- Update `ProfileUpdateData` interface to include level-related fields
- Update `getCurrentUser()` response to include level validation data

### Admin Level Validation Page

**File**: `ui/src/pages/AdminLevelValidation.tsx` (new file)

- Create admin-only page for managing level validation requests
- Display table of pending requests with:
  - Player name, email, current approved level, claimed level
  - Date when level was claimed
  - Action buttons: Approve, Reject
- For each action, show modal with:
  - Player details and level change summary
  - Optional notes field for admin comments
  - Confirm action button
- After action, remove from pending list and show success message
- Include filter/search functionality for large lists

**File**: `ui/src/App.tsx` (modify existing)

- Add new route `/admin/level-validation` for the admin page
- Protect route with existing `AdminRoute` component

**File**: `ui/src/components/appSidebar.tsx` (modify existing)

- Add "Level Validation" menu item under Admin section
- Link to `/admin/level-validation`

### Level Validation Status Components

**File**: `ui/src/components/LevelStatusBadge.tsx` (new file)

- Create reusable component for displaying level validation status
- Props: `status`, `level?`, `notes?`, `validatedAt?`
- Visual indicators:
  - Green badge with checkmark for "approved"
  - Orange badge with clock for "pending"
  - Red badge with X for "rejected"
  - Gray badge for "none"
- Show level number and validation date when applicable

**File**: `ui/src/components/LevelSelector.tsx` (new file)

- Create level selection component for profile page
- Props: `value`, `onChange`, `disabled`, `validationStatus`
- Disabled state when validation is pending
- Show current status next to selector

### Data Flow Algorithm

1. **Player Claims Level**:
   - Player selects new level in profile
   - API call sets `claimed_level` and `level_validation_status` to "pending"
   - UI shows pending status and disables further changes

2. **Admin Reviews Requests**:
   - Admin visits level validation page
   - API returns all users with `level_validation_status = "pending"`
   - Admin sees list of pending requests with player details

3. **Admin Approves/Rejects**:
   - Admin clicks approve/reject with optional notes
   - API updates user record:
     - If approved: `level_validation_status = "approved"`, `level_validated_at = now()`, `level_validated_by = admin_id`
     - If rejected: `level_validation_status = "rejected"`, `level_validation_notes = notes`
   - Player's profile immediately reflects new status

4. **Status Display**:
   - Profile page shows current validation status
   - Level selector is disabled while pending
   - Status badge shows appropriate color and icon
   - Rejection notes are displayed if applicable

### Validation Rules

- Players can only have one pending validation request at a time
- Once approved, the `claimed_level` becomes the player's validated level
- Players can claim a new level after previous request is resolved
- Admins can see full history of level changes in validation page
- Level changes are logged with timestamps and admin who validated

### Error Handling

- Handle case where player tries to change level while pending
- Handle admin trying to validate same request twice
- Show appropriate error messages for validation failures
- Handle network errors gracefully with retry options

### UI/UX Considerations

- Clear visual distinction between different validation states
- Intuitive workflow for both players and admins
- Responsive design for mobile admin access
- Loading states for all async operations
- Success/error notifications for actions

## File Structure

```
server/src/
├── schema/
│   └── users.ts (modify)
├── drizzle/
│   └── 0003_add_level_validation.sql (new)
└── api.ts (modify)

ui/src/
├── pages/
│   ├── Profile.tsx (modify)
│   └── AdminLevelValidation.tsx (new)
├── components/
│   ├── LevelStatusBadge.tsx (new)
│   ├── LevelSelector.tsx (new)
│   └── appSidebar.tsx (modify)
├── lib/
│   └── serverComm.ts (modify)
└── App.tsx (modify)
```

## Dependencies

- Existing level enum from leagues schema
- Existing admin middleware and route protection
- Existing shadcn components: Button, Card, Table, Dialog, Select, Badge
- React Router for navigation
- Date handling for validation timestamps
