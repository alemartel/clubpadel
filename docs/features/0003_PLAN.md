# League and Group Management System Plan

## Overview

Implement a league and group management system where only admins can create leagues. Leagues contain groups with specific constraints: leagues have start and end dates, name, and groups; groups have level, gender, and name with unique name constraint within each league.

## Technical Requirements

### Database Schema Changes

#### New Tables and Enums

**File**: `server/src/schema/leagues.ts` (new file)

- Create `genderEnum` with values ["male", "female", "mixed"]
- Create `levelEnum` with values ["1", "2", "3", "4"]
- Create `leagues` table with:
  - `id` (text, primary key)
  - `name` (text, not null)
  - `start_date` (timestamp, not null)
  - `end_date` (timestamp, not null)
  - `created_by` (text, foreign key to users.id, not null)
  - `created_at` (timestamp, default now)
  - `updated_at` (timestamp, default now)
- Create `groups` table with:
  - `id` (text, primary key)
  - `league_id` (text, foreign key to leagues.id, not null)
  - `name` (text, not null)
  - `level` (levelEnum, not null)
  - `gender` (genderEnum, not null)
  - `created_at` (timestamp, default now)
  - `updated_at` (timestamp, default now)
  - Unique constraint on `(league_id, name)` for group name uniqueness within league

#### Database Migration

**File**: `server/drizzle/0002_add_leagues_and_groups.sql` (new migration file)

- Create enum types `gender` and `level`
- Create `app.leagues` table
- Create `app.groups` table with foreign key constraints
- Add unique constraint on group names within leagues

### API Implementation

#### Admin Middleware

**File**: `server/src/middleware/admin.ts` (new file)

- Create `adminMiddleware` that checks if authenticated user has "admin" role
- Return 403 Forbidden if user is not admin
- Set admin user in context for use in endpoints

#### League Management Endpoints

**File**: `server/src/api.ts` (modify existing)

- Add admin-protected routes section
- `POST /api/v1/admin/leagues` - Create new league (admin only)
- `GET /api/v1/admin/leagues` - List all leagues (admin only)
- `GET /api/v1/admin/leagues/:id` - Get specific league with groups (admin only)
- `PUT /api/v1/admin/leagues/:id` - Update league (admin only)
- `DELETE /api/v1/admin/leagues/:id` - Delete league (admin only)

#### Group Management Endpoints

**File**: `server/src/api.ts` (modify existing)

- `POST /api/v1/admin/leagues/:leagueId/groups` - Create group in league (admin only)
- `GET /api/v1/admin/leagues/:leagueId/groups` - List groups in league (admin only)
- `PUT /api/v1/admin/groups/:id` - Update group (admin only)
- `DELETE /api/v1/admin/groups/:id` - Delete group (admin only)

#### Public League Endpoints

**File**: `server/src/api.ts` (modify existing)

- `GET /api/v1/leagues` - List all leagues (public)
- `GET /api/v1/leagues/:id` - Get specific league with groups (public)
- `GET /api/v1/leagues/:id/groups` - List groups in league (public)

### Data Validation

#### League Creation Algorithm

1. Validate required fields: name, start_date, end_date
2. Validate date logic: start_date < end_date
3. Check if league name is unique (optional constraint)
4. Create league record with authenticated admin as creator
5. Return created league with groups (initially empty)

#### Group Creation Algorithm

1. Validate required fields: name, level, gender
2. Validate enum values: level must be in ["beginner", "intermediate", "advanced"], gender must be in ["male", "female", "mixed"]
3. Check unique constraint: group name must be unique within the specified league
4. Create group record linked to league
5. Return created group

#### Group Name Uniqueness Algorithm

1. Query existing groups in the league: `SELECT name FROM app.groups WHERE league_id = ?`
2. Check if provided name exists in results
3. If exists, return validation error
4. If unique, proceed with creation

### TypeScript Types

**File**: `server/src/schema/leagues.ts` (modify existing)

- Export `League` type from leagues table inference
- Export `NewLeague` type from leagues table inference
- Export `Group` type from groups table inference
- Export `NewGroup` type from groups table inference
- Export `Gender` and `Level` enum types

### Error Handling

- Return 403 Forbidden for non-admin users attempting admin operations
- Return 400 Bad Request for validation errors (invalid dates, enum values, duplicate group names)
- Return 404 Not Found for non-existent leagues/groups
- Return 409 Conflict for duplicate group names within league
- Return 500 Internal Server Error for database errors

### Database Relationships

- `leagues.created_by` → `users.id` (foreign key)
- `groups.league_id` → `leagues.id` (foreign key)
- Cascade delete: when league is deleted, all associated groups are deleted
- Unique constraint: `groups(league_id, name)` ensures group name uniqueness per league
