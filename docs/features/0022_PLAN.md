# League Management with Level and Gender and Team Assignment

## Context

Administrators need to create leagues defined by level and gender (not through groups). Administrators can add teams to leagues. A team can only be in one not started or in progress league at a time (no problem with completed past leagues). League status is determined by dates: not started (start_date in future), in progress (current date between start_date and end_date), or completed (end_date in past).

## Files/Modules to Update

### Database Schema Changes

**File**: `server/src/schema/leagues.ts`

- Add `level` field to `leagues` table:
  - `level: levelEnum("level").notNull()` - League level (1, 2, 3, 4)
- Add `gender` field to `leagues` table:
  - `gender: genderEnum("gender").notNull()` - League gender (male, female, mixed)
- Update `League` and `NewLeague` types to include level and gender fields

**File**: `server/drizzle/XXXX_add_level_gender_to_leagues.sql` (new migration file)

- Add `level` column to `app.leagues` table (type: `level` enum, not null)
- Add `gender` column to `app.leagues` table (type: `gender` enum, not null)
- For existing leagues, set default values (or make migration require manual data entry)
- Add check constraint or ensure data consistency

### Backend API Changes

**File**: `server/src/api.ts`

#### League Creation Endpoint (modify existing `POST /api/v1/admin/leagues`)

- Modify league creation endpoint (around line 377-432):
  - Add `level` and `gender` to required fields validation
  - Validate `level` is one of ["1", "2", "3", "4"]
  - Validate `gender` is one of ["male", "female", "mixed"]
  - Include `level` and `gender` in `newLeague` object when creating league
  - Update error messages to include level and gender requirements

#### League Update Endpoint (modify existing `PUT /api/v1/admin/leagues/:id`)

- Modify league update endpoint (around line 481-524):
  - Allow updating `level` and `gender` fields
  - Validate level and gender enum values if provided
  - Include level and gender in updateData if provided

#### Add Team to League Endpoint (new endpoint)

- Add new admin-protected endpoint: `POST /api/v1/admin/leagues/:leagueId/teams`
- Request body: `{ team_id: string }`
- Validation:
  - Check league exists
  - Check team exists
  - Validate team level matches league level (or allow mismatch - clarify requirement)
  - Validate team gender matches league gender (or allow mismatch - clarify requirement)
  - **Check if team is already in a not started or in progress league:**
    - Query teams table for team's current league_id
    - If league_id exists, query leagues table for that league
    - Calculate league status based on dates:
      - Not started: `start_date > current_date`
      - In progress: `start_date <= current_date AND end_date >= current_date`
      - Completed: `end_date < current_date`
    - If team is in a not started or in progress league, return error (409 Conflict) with message indicating which league the team is already in
    - If team is in a completed league, allow adding to new league
- If validation passes:
  - Update team's `league_id` field to the new league
  - Update team's `updated_at` timestamp
  - Return success response with updated team

#### Remove Team from League Endpoint (new endpoint)

- Add new admin-protected endpoint: `DELETE /api/v1/admin/leagues/:leagueId/teams/:teamId`
- Validation:
  - Check league exists
  - Check team exists and is assigned to this league
- Action:
  - Set team's `league_id` to null
  - Update team's `updated_at` timestamp
  - Return success response

#### Get League Teams Endpoint (new endpoint)

- Add new admin-protected endpoint: `GET /api/v1/admin/leagues/:leagueId/teams`
- Query all teams where `league_id` equals the leagueId
- Return teams array with team details

#### Helper Function: Get League Status

- Create helper function `getLeagueStatus(league: League): "not_started" | "in_progress" | "completed"`
  - Takes a league with start_date and end_date
  - Returns "not_started" if `start_date > current_date`
  - Returns "in_progress" if `start_date <= current_date AND end_date >= current_date`
  - Returns "completed" if `end_date < current_date`
  - Handle null dates appropriately (if dates are optional)

### Frontend API Client

**File**: `ui/src/lib/serverComm.ts`

- Update `NewLeague` interface:
  - Add `level: "1" | "2" | "3" | "4"` field (required)
  - Add `gender: "male" | "female" | "mixed"` field (required)

- Update `UpdateLeague` interface:
  - Add `level?: "1" | "2" | "3" | "4"` field (optional)
  - Add `gender?: "male" | "female" | "mixed"` field (optional)

- Add `addTeamToLeague(leagueId: string, teamId: string)` function:
  - POST to `/api/v1/admin/leagues/${leagueId}/teams`
  - Body: `{ team_id: teamId }`
  - Returns updated team

- Add `removeTeamFromLeague(leagueId: string, teamId: string)` function:
  - DELETE to `/api/v1/admin/leagues/${leagueId}/teams/${teamId}`
  - Returns success message

- Add `getLeagueTeams(leagueId: string)` function:
  - GET from `/api/v1/admin/leagues/${leagueId}/teams`
  - Returns teams array

- Add `getLeagueStatus(league: League): "not_started" | "in_progress" | "completed"` function:
  - Helper function that calculates league status based on start_date and end_date
  - Can be used in both frontend and backend for consistency

### Frontend - Admin Leagues Page

**File**: `ui/src/pages/AdminLeagues.tsx`

- Modify league creation form:
  - Add level select field (options: 1, 2, 3, 4)
  - Add gender select field (options: Masculine, Femenine, Mixed - map to male, female, mixed)
  - Both fields required for league creation
  - Update `leagueForm` state to include level and gender

- Modify league edit form:
  - Add level select field (pre-populated with current value)
  - Add gender select field (pre-populated with current value)
  - Allow updating level and gender

- Add team management section to league detail view:
  - Display list of teams currently in the league (call `getLeagueTeams`)
  - Add "Add Team" button that opens a modal/dialog
  - Modal should:
    - Display list of available teams (filtered by level and gender if needed, or show all teams)
    - Show search/filter functionality to find teams
    - Display team name, level, gender, current league status if assigned
    - Allow selecting a team to add
    - On selection, call `addTeamToLeague`
    - Handle errors (e.g., team already in another active league)
    - Refresh team list on success
  - For each team in the league:
    - Display team name, level, gender
    - Add "Remove" button that calls `removeTeamFromLeague`
    - Confirm removal with dialog

- Display league status badge/indicator:
  - Show "Not Started", "In Progress", or "Completed" based on dates
  - Use different colors/styles for each status
  - Update status calculation using `getLeagueStatus` helper

### Frontend - Translation Files

**File**: `ui/src/locales/en/leagues.json`

- Add translation keys:
  - `"leagueLevel": "Level"`
  - `"leagueGender": "Gender"`
  - `"selectLevel": "Select level"`
  - `"selectGender": "Select gender"`
  - `"levelRequired": "Level is required"`
  - `"genderRequired": "Gender is required"`
  - `"addTeamToLeague": "Add team to league"`
  - `"removeTeamFromLeague": "Remove team from league"`
  - `"leagueTeams": "Teams in this league"`
  - `"noTeamsInLeague": "No teams in this league"`
  - `"selectTeamToAdd": "Select a team to add"`
  - `"teamAlreadyInActiveLeague": "This team is already in an active league"`
  - `"teamAddedToLeague": "Team added to league successfully"`
  - `"teamRemovedFromLeague": "Team removed from league successfully"`
  - `"removeTeamConfirm": "Are you sure you want to remove this team from the league?"`
  - `"notStarted": "Not started"`
  - `"inProgress": "In progress"`
  - `"completed": "Completed"`
  - `"leagueStatus": "League status"`

**File**: `ui/src/locales/es/leagues.json`

- Add Spanish translations for all the new keys above

## Algorithmic/Logical Notes

### League Status Calculation

League status is determined by comparing current date with league dates:
1. **Not started**: `start_date > current_date` (or if start_date is null, consider as not started)
2. **In progress**: `start_date <= current_date AND end_date >= current_date` (current date is within league date range)
3. **Completed**: `end_date < current_date` (end date has passed)

### Team to League Assignment Validation

Before adding a team to a league, validate:
1. Team exists
2. League exists
3. Team level matches league level (or should we allow mismatch? - assuming they must match)
4. Team gender matches league gender (or should we allow mismatch? - assuming they must match)
5. **Team is not already in an active league:**
   - Check if team has a `league_id` (not null)
   - If league_id exists, query the league
   - Calculate that league's status using dates
   - If status is "not_started" or "in_progress", reject with error
   - If status is "completed", allow assignment (team can be in multiple completed leagues)

### Team Matching Logic

When adding teams to leagues:
- Team level must match league level (e.g., Level 1 team can only join Level 1 league)
- Team gender must match league gender (e.g., male team can only join male league)

### Database Queries

**Check if team is in active league:**
```sql
SELECT l.* FROM teams t
JOIN leagues l ON t.league_id = l.id
WHERE t.id = ? 
  AND (l.start_date > CURRENT_DATE OR (l.start_date <= CURRENT_DATE AND l.end_date >= CURRENT_DATE))
```

**Get teams in league:**
```sql
SELECT * FROM teams WHERE league_id = ?
```

**Update team league assignment:**
```sql
UPDATE teams SET league_id = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
```

## UI/UX Details

### League Creation/Edit Form
- Level select: Dropdown with options "Level 1", "Level 2", "Level 3", "Level 4"
- Gender select: Dropdown with options "Masculine", "Femenine", "Mixed"
- Both fields should be clearly labeled and required

### League Detail/Team Management
- Display league status prominently (badge with color coding)
- Team list should show team name, level, gender, and any other relevant info
- "Add Team" button should be prominent and easy to find
- Team removal should require confirmation to prevent accidental removal
- Show helpful error messages when team cannot be added (e.g., "Team 'X' is already in active league 'Y'")

