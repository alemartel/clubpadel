# Team Creation and Management System Plan

## Overview

Implement a team creation and management system where players with validated levels can create teams within specific leagues and groups. Teams must have unique names within their league, and team creators can manage team members through a free player market that shows only players with validated levels matching the team's level. Administrators do not need access to team creation functionality.

## Technical Requirements

### Database Schema Changes

#### New Tables

**File**: `server/src/schema/teams.ts` (new file)

- Create `teams` table with:
  - `id` (text, primary key)
  - `name` (text, not null)
  - `league_id` (text, foreign key to leagues.id, not null)
  - `group_id` (text, foreign key to groups.id, not null)
  - `created_by` (text, foreign key to users.id, not null)
  - `created_at` (timestamp, default now)
  - `updated_at` (timestamp, default now)
  - Unique constraint on `(league_id, name)` for team name uniqueness within league

- Create `team_members` table with:
  - `id` (text, primary key)
  - `team_id` (text, foreign key to teams.id, not null)
  - `user_id` (text, foreign key to users.id, not null)
  - `role` (text, default "member") - Future extensibility for captain/co-captain roles
  - `joined_at` (timestamp, default now)
  - Unique constraint on `(team_id, user_id)` to prevent duplicate memberships

#### Database Migration

**File**: `server/drizzle/0003_add_teams_and_members.sql` (new migration file)

- Create `app.teams` table with foreign key constraints
- Create `app.team_members` table with foreign key constraints
- Add unique constraint on team names within leagues
- Add unique constraint on team member relationships

### API Implementation

#### Team Management Endpoints

**File**: `server/src/api.ts` (modify existing)

- Add protected routes section for team management:
  - `POST /api/v1/protected/teams` - Create new team (validated players only)
  - `GET /api/v1/protected/teams` - Get user's teams
  - `GET /api/v1/protected/teams/:id` - Get specific team details
  - `PUT /api/v1/protected/teams/:id` - Update team details (team creator only)
  - `DELETE /api/v1/protected/teams/:id` - Delete team (team creator only)
  - `POST /api/v1/protected/teams/:id/members` - Add member to team
  - `DELETE /api/v1/protected/teams/:id/members/:userId` - Remove member from team

- Add free player market endpoint:
  - `GET /api/v1/protected/players/free-market` - Get available players for team level
    - Query parameters: `level`, `gender`, `exclude_team_id` (optional)

#### Validation Logic

**File**: `server/src/api.ts` (modify existing)

- Team creation validation:
  - Check user has `level_validation_status = "approved"`
  - Check team name is unique within league
  - Validate league and group exist and are accessible
  - Ensure user's validated level matches group level

- Team member addition validation:
  - Check target player has `level_validation_status = "approved"`
  - Check target player's validated level matches team's group level
  - Check player is not already on another team in the same league
  - Check team has capacity (future: implement team size limits)

### UI Implementation

#### Sidebar Navigation Updates

**File**: `ui/src/components/appSidebar.tsx` (modify existing)

- Add "Teams" section to sidebar (only visible to non-admin players)
- Add "Create Team" menu item for players with validated levels
- Add "My Teams" menu item for all players
- Use level validation status check to conditionally show create team option

#### Team Creation Page

**File**: `ui/src/pages/CreateTeam.tsx` (new file)

- Create team form with fields:
  - Team name (text input with validation)
  - League selection (dropdown of available leagues)
  - Group selection (dropdown filtered by selected league)
- Form validation:
  - Team name required and unique within league
  - League and group must be selected
  - User must have validated level matching selected group
- Success handling: redirect to team detail page

#### Team Detail Page

**File**: `ui/src/pages/TeamDetail.tsx` (new file)

- Display team information:
  - Team name, league, group, creation date
  - Team members list with roles
- Team management actions (for team creator):
  - Edit team details
  - Delete team
  - Manage team members
- Free player market integration:
  - Search and filter available players
  - Display player information (name, level, validation status)
  - Add/remove players from team

#### My Teams Page

**File**: `ui/src/pages/MyTeams.tsx` (new file)

- List all teams user is member of
- Show team details (name, league, group, member count)
- Quick actions (view team, leave team)
- Create new team button (if user has validated level)

#### Free Player Market Component

**File**: `ui/src/components/FreePlayerMarket.tsx` (new file)

- Searchable and filterable player list
- Display player cards with:
  - Name, email, validated level
  - Join/leave team buttons
- Real-time updates when players are added/removed
- Pagination for large player lists

### API Integration

**File**: `ui/src/lib/serverComm.ts` (modify existing)

- Add team management API functions:
  - `createTeam(data)` - Create new team
  - `getMyTeams()` - Get user's teams
  - `getTeam(id)` - Get specific team details
  - `updateTeam(id, data)` - Update team details
  - `deleteTeam(id)` - Delete team
  - `addTeamMember(teamId, userId)` - Add member to team
  - `removeTeamMember(teamId, userId)` - Remove member from team
  - `getFreePlayers(level, gender, excludeTeamId?)` - Get available players

### Authentication Context Updates

**File**: `ui/src/lib/auth-context.tsx` (modify existing)

- Extend `ServerUser` type to include level validation fields:
  - `claimed_level`
  - `level_validation_status`
  - `level_validated_at`
- Add computed fields:
  - `hasValidatedLevel` - boolean for level validation status
  - `canCreateTeams` - boolean for team creation eligibility

### Routing Updates

**File**: `ui/src/App.tsx` (modify existing)

- Add new routes:
  - `/teams` - My Teams page
  - `/teams/create` - Create Team page
  - `/teams/:id` - Team Detail page
- Add route protection for team creation (validated level required)

### Form Validation

**File**: `ui/src/lib/validation.ts` (modify existing)

- Add team validation schemas:
  - `validateTeamCreation` - team name, league, group validation
  - `validateTeamUpdate` - team name uniqueness validation
- Add player market validation:
  - `validatePlayerSearch` - search parameters validation

## Implementation Phases

### Phase 1: Data Layer
1. Create database schema and migration
2. Update API endpoints for team management
3. Add team-related types and interfaces

### Phase 2: Core Team Management
1. Implement team creation functionality
2. Create team detail and management pages
3. Add sidebar navigation updates

### Phase 3: Player Market Integration
1. Implement free player market component
2. Add team member management functionality
3. Integrate player search and filtering

### Phase 4: Polish and Testing
1. Add comprehensive form validation
2. Implement error handling and user feedback
3. Add loading states and optimistic updates

## File Structure

```
server/src/
├── schema/
│   └── teams.ts (new)
├── drizzle/
│   └── 0003_add_teams_and_members.sql (new)
└── api.ts (modify)

ui/src/
├── pages/
│   ├── CreateTeam.tsx (new)
│   ├── TeamDetail.tsx (new)
│   └── MyTeams.tsx (new)
├── components/
│   ├── FreePlayerMarket.tsx (new)
│   └── appSidebar.tsx (modify)
├── lib/
│   ├── auth-context.tsx (modify)
│   ├── serverComm.ts (modify)
│   └── validation.ts (modify)
└── App.tsx (modify)
```

## Dependencies

- Existing shadcn components: Button, Card, Input, Label, Select, Table
- New shadcn components: Dialog (for confirmations), Badge (for member roles)
- React Router for navigation
- Form validation with existing validation patterns
- Real-time updates (future: WebSocket integration)
